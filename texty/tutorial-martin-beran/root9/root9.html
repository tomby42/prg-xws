<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System (9)</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<H2>Pøehled widgetù</H2>

<P>V toolkitu Qt jsou k&nbsp;dispozici obdobné widgety jako v&nbsp;GTK+. Proto zde jen
velmi struènì vyjmenuji ty nejdùle¾itìj¹í. V¹echny widgety jsou odvozené
z&nbsp;bázové tøídy <TT>QWidget</TT>. Pro tlaèítka existují tøídy
<TT>QPushButton</TT>, <TT>QCheckBox</TT> a <TT>QRadioButton</TT>. Pøepínatelné
tlaèítko nemá samostatnou tøídu. Místo toho je ve <TT>QPushButton</TT>
definovaná property <TT>toggleButton</TT>. Statický text <TT>QLabel</TT> mù¾e
obsahovat prostý text, rich text (formátovaný text, který vypadá jako
zjednodu¹ené HTML), èíslo, obrázek nebo animaci. Pro vkládání jednoøádkových
textových hodnot slou¾í <TT>QLineEdit</TT>. Numerické hodnoty lze zadávat
pomocí <TT>QSlider</TT>, <TT>QDial</TT> a <TT>QSpinButton</TT>. Jestli¾e
chceme u¾ivateli nabídnout výbìr ze seznamu mo¾ností, máme k&nbsp;dispozici widgety
<TT>QListBox</TT> a <TT>QComboBox</TT>. Widget <TT>QScrollView</TT> funguje
jako obecná posuvná oblast, spolupracující se scrollbary <TT>QScrollBar</TT>.
Ze tøídy <TT>QScrollView</TT> jsou odvozeny widgety pro vícesloupcový
seznam/strom (<TT>QListView</TT>), editaci textu (<TT>QTextEdit</TT>) a
zobrazení formátovaného hypertextu (<TT>QTextBrowser</TT>). Qt obsahuje také
widgety na zobrazení a editaci dat v&nbsp;SQL databázích: <TT>QDataTable</TT>,
<TT>QDataBrowser</TT> a <TT>QDataView</TT>.

<P>Pro vizuální slouèení logicky souvisejících widgetù do rámeèku s&nbsp;nadpisem
se &ndash; pøedev¹ím v&nbsp;dialozích &ndash; pou¾ívají <TT>QGroupBox</TT> a
<TT>QButtonGroup</TT>. Tøída <TT>QSplitter</TT> je okno s&nbsp;nìkolika panely
oddìlenými u¾ivatelem posouvatelnými pøepá¾kami. Kolekce stránek pro dialogy
obsahující velké mno¾ství widgetù se v&nbsp;Qt jmenuje <TT>QTabWidget</TT>.
Hlavní okno aplikace je <TT>QMainWindow</TT>. Obsahuje pøedpøipravený pruh
menu <TT>QMenuBar</TT>, dokovací oblasti <TT>QDockArea</TT> pro toolbary
(<TT>QToolBar</TT>) a stavový øádek <TT>QStatusBar</TT>. Pro rozbalovací menu
existuje tøída <TT>QPopupMenu</TT>. 

<P>Dialogová okna se v&nbsp;Qt realizují pomocí tøídy <TT>QDialog</TT>. Dialog mù¾e
být zobrazen ve dvou re¾imech. V&nbsp;základním re¾imu jsou zobrazené pouze
nejèastìji pou¾ívané polo¾ky. Navíc je v&nbsp;dialogu tlaèítko napojené na slot
<TT>QDialog::showExtension</TT>. Tím se zobrazí dal¹í polo¾ky dialogu,
nastavené pøedtím voláním <TT>QDialog::setExtension</TT>. Nemodální dialog se
zobrazí stejnì jako libovolné jiné okno metodou <TT>show</TT>. Zpracování
událostí v&nbsp;aplikaci probíhá normálnì dál a v&nbsp;reakci na signál <TT>clicked</TT>
po stisku nìkterého tlaèítka v&nbsp;dialogu dojde k&nbsp;pøeètení nastavených hodnot a
zavøení dialogu. Modální dialog se spustí metodou <TT>QDialog::exec</TT>.
Ukonèení dialogu a nastavení návratové hodnoty pro <TT>exec</TT> zajistí sloty
<TT>QDialog::accept</TT>, <TT>reject</TT> a <TT>done</TT>. Obvykle se
pøipojují k&nbsp;signálu <TT>clicked</TT> tlaèítek &bdquo;OK&ldquo; a
&bdquo;Cancel&ldquo;.

<H2>Datové struktury</H2>

<P>V knihovnì Qt je definována i øada tøíd, které nejsou widgety. Nìkteré
datové typy poskytují podobné funkce jako tøídy ze standardní knihovny C++.
Jedná se o&nbsp;kontejnerové tøídy <TT>QMap</TT>, <TT>QValueList</TT> a
<TT>QValueVector</TT>, které odpovídají STL kontejnerùm <TT>map</TT>,
<TT>list</TT> a <TT>vector</TT>. K&nbsp;tìmto kontejnerovým tøídám jsou definované
i pøíslu¹né iterátory a algoritmy. Toolkit Qt pro své vlastní potøeby pou¾ívá
datové struktury definované v&nbsp;Qt, nicménì jinde v&nbsp;programu je lze kombinovat
s&nbsp;kontejnery z&nbsp;STL.

<P>Asi nejdùle¾itìj¹í datový typ v&nbsp;Qt je <TT>QString</TT>. Toolkit jej pou¾ívá
prakticky v¹ude, kde se pracuje s&nbsp;textem. Objekt tøídy <TT>QString</TT>
reprezentuje textový øetìzec v&nbsp;kódování Unicode. Pou¾ívá implicitní sdílení
dat, tak¾e kopírování øetìzcù je relativnì nenároèná operace a ke skuteènému
zkopírování dat øetìzce dojde a¾ pøi zmìnì originálu nebo kopie. Místo
alokované pro øetìzec se automaticky zvìt¹uje podle potøeby. Podporována je
konverze z&nbsp;a do øetìzcù ve stylu C (<TT>char&nbsp;*</TT>) vèetnì
pøekódování mezi Unicode a ASCII, resp. jinými 8bitovými kódováními. Dále jsou
v&nbsp;<TT>QString</TT> definovány metody pro porovnání øetìzcù, zmìny, hledání
podle regulárních výrazù, apod. Alternativnì Qt poskytuje i abstrakci
klasických nulou ukonèených øetìzcù: <TT>QCString</TT>. Tato tøída pou¾ívá
explicitní sdílení dat a nabízí podobnou mno¾inu operací jako
<TT>QString</TT>,  ale tyto operace jsou èasto ménì efektivní.

<H2>Èasovaèe, I/O, procesy</H2>

<P>Podobnì jako v&nbsp;GTK+, i aplikace v&nbsp;Qt nìkdy potøebují provést nìjakou akci
periodicky a nezávisle na událostech pøicházejících od X serveru. Pro tyto
úèely existuje tøída <TT>QTimer</TT>. Èasovaè je tøeba nejprve vytvoøit.

<PRE>
QTimer *t = new QTimer(parent);
</PRE>

V¾dy pøi vypr¹ení èasu se vygeneruje signál <TT>timeout</TT>, který lze
napojit na slot implementující po¾adovanou periodickou akci.

<PRE>
connect(t, SIGNAL(timeout()), parent, SLOT(timeoutExpired()));
</PRE>

Pak u¾ mù¾eme nastartovat periodický 

<PRE>
t-&gt;start(2000);
</PRE>

nebo jednorázový èasovaè.

<PRE>
t-&gt;start(2000, TRUE);
</PRE>

Èas se zadává v&nbsp;milisekundách. Speciální hodnota 0 funguje obdobnì jako idle
funkce v&nbsp;GTK+ &ndash; signál <TT>timeout</TT> se emituje, pokud je prázdná
fronta událostí.

<P>Pro sí»ové aplikace, je¾ potøebují zároveò zpracovávat události a èekat
na data na soketu, existuje <TT>QSocketNotifier</TT>. V&nbsp;konstruktoru se
nastavuje deskriptor soketu a typ událostí, na které se bude èekat
(<TT>Read</TT>, <TT>Write</TT>, <TT>Exception</TT>). Kdy¾ nastane po¾adovaná
událost, <TT>QSocketNotifier</TT> emituje signál <TT>activated</TT>.

<P>Qt obsahuje i tøídy pro na platformì nezávislé ètení a zápis souborù
(<TT>QFile</TT>), procházení adresáøù (<TT>QDir</TT>), zji¹»ování informací
o&nbsp;souborech (<TT>QFileInfo</TT>) a sí»ové funkce (<TT>QSocket</TT>,
<TT>QFtp</TT>, <TT>QHttp</TT> a <TT>QDns</TT>). Na ètení a zápis textu do
souboru nebo soketu slou¾í tøída <TT>QTextStream</TT>, která poskytuje obvyklé
streamové pøetí¾ené operátory <TT>operator&lt;&lt;</TT> a
<TT>operator&gt;&gt;</TT>. Tøída <TT>QProcess</TT> umí spustit externí program
s&nbsp;argumenty, asynchronnì psát na jeho standardní vstup, èíst jeho standardní a
chybový výstup, zjistit jeho PID, detekovat ukonèení, pøeèíst návratový kód a
násilnì bìh programu ukonèit.

<H2>Konfigurace programù</H2>

<P>Qt poskytuje platformnì nezávislé API pro ukládání konfigurace aplikací
&ndash; tøídu <TT>QSettings</TT>. Ve Windows se pou¾ívá systémový registr. Na
unixových systémech se konfiguraèní hodnoty ukládají do textových souborù
v&nbsp;adresáøi <TT>$HOME/.qt</TT>. Seznam adresáøù, ve kterých se hledají
konfiguraèní soubory, lze upravovat pomocí metod
<TT>QSettings::insertSearchPath</TT> a <TT>QSettings::removeSearchPath</TT>.

<P>Ka¾dá polo¾ka konfigurace je dvojice klíè, hodnota. Klíè je posloupnost
dvou nebo více èástí oddìlených lomítky: <TT>/Program/Sekce/klic1/klic2</TT>.
Takto pojmenovaná polo¾ka bude ulo¾ena jako <TT>klic1/klic2</TT> v&nbsp;sekci
<TT>[Sekce]</TT> v&nbsp;souboru <TT>$HOME/.qt/program</TT>. Pokud má klíè jen dvì
èásti <TT>/Program/klic</TT>, ulo¾í se do sekce <TT>[General]</TT> v souboru
<TT>$HOME/.qt/program</TT>.

<P>Hodnoty jsou typu boolean, integer, double, øetìzec, nebo seznam øetìzcù.
Pro ulo¾ení hodnoty slou¾í pøetí¾ená metoda <TT>writeEntry</TT>. Metod pro
ètení je nìkolik, pro ka¾dý podporovaný typ jedna: <TT>readBoolEntry</TT>,
<TT>readNumEntry</TT>, <TT>readDoubleEntry</TT>, <TT>readEntry</TT> a
<TT>readListEntry</TT>. Klíè spolu s&nbsp;pøiøazenou hodnotou zru¹í metoda
<TT>removeEntry</TT>. Jednotlivé èásti jmen klíèù definují stromovou strukturu
konfiguraèních hodnot, podobnì jako cesty k&nbsp;souborùm definují stromovou 
hierarchii adresáøù ve file systému. Pro urèitý uzel konfiguraèního stromu lze
získat seznam synovských uzlù pomocí <TT>entryList</TT> (klíèe, které obsahují
hodnoty) a <TT>subkeyList</TT> (klíèe obsahující podklíèe ni¾¹í úrovnì).

<H2>Komunikace mezi programy</H2>

<P>Uká¾eme si dva zpùsoby realizace meziprocesové komunikace v&nbsp;Qt. Oba
vyu¾ívají standardní Xové mechanismy. To znamená, ¾e se data pøená¹í
prostøednictvím X serveru a komunikující procesy nemusí mít mezi sebou pøímé
spojení. Navíc se dá komunikovat i s&nbsp;programy nepou¾ívajícími Qt.

<P>Tøída <TT>QClipboard</TT> se pou¾ívá pro operace cut&amp;paste. V&nbsp;aplikaci
existuje pouze jedna její instance <TT>QApplication::clipboard</TT>.
Podporovány jsou operace vlo¾ení dat do clipboardu a pøeètení dat
z&nbsp;clipboardu. Pøená¹ejí se buï texty (metody <TT>text</TT> a <TT>setText</TT>),
obrázky (<TT>image</TT>, <TT>pixmap</TT>, <TT>setImage</TT> a
<TT>setPixmap</TT>), nebo data v&nbsp;libovolném formátu identifikovaném MIME typem
(<TT>data</TT>, <TT>setData</TT>).

<P>Operace drag&amp;drop zaèíná typicky tak, ¾e u¾ivatel zaène táhnout my¹í
nìjaký objekt na obrazovce. V&nbsp;handleru pro tuto událost
(<TT>mouseMoveEvent</TT>) program vytvoøí instanci nìkteré tøídy odvozené
z&nbsp;<TT>QDragObject</TT> a zavolá její metodu <TT>drag</TT>. Widget, který mù¾e
být cílem drag&amp;drop, to musí povolit pomocí <TT>setAcceptDrops(TRUE)</TT>.
Dále je v&nbsp;nìm tøeba pøedefinovat minimálnì dva handlery událostí. V&nbsp;metodì
<TT>dragEnterEvent</TT> se testuje, zda pøená¹ená data mohou být konvertována
do po¾adovaného formátu a podle toho se akceptuje událost, napø.

<PRE>
event-&gt;accept(QTextDrag::canDecode(event));
</PRE>

Metoda <TT>dropEvent</TT> pak zajistí pøeètení dat:

<PRE>
if(QTextDrag::decode(event, text))
    insertTextAt(text, event-&gt;pos());
</PRE>

<H2>Internacionalizace a lokalizace</H2>

<P>Internacionalizace programu (èasto se zkracuje jako i18n) je pøidání
základní podpory pro rùzné jazykové a místní zvyklosti. Lokalizace (l10n) je
pak napø. pøidání databáze pøelo¾ených textù, nastavení znakové sady a
pravidel lexikografického tøídìní pro konkrétní jazyk nebo definování pravidel
pro zápis èísel a penì¾ních èástek pou¾ívaných v&nbsp;urèité zemi. My se zamìøíme
na pøeklad textù, tedy rùzných hlá¹ení programu, polo¾ek menu, popisek prvkù
dialogu, apod.

<P>Základní pravidlo je pou¾ívat typ <TT>QString</TT> pro v¹echny texty, je¾
se budou zobrazovat u¾ivateli. Ka¾dý takový øetìzec se obalí voláním funkce
<TT>tr</TT>:

<PRE>
QWidget *w = new QLabel(tr("Full file path:"), dlg);
</PRE>

Pøi definici akcelerátorù je vhodné pou¾ívat tøídu <TT>QKeySequence</TT>,
která dovoluje zadat akcelerátor pomocí øetìzce a tudí¾ na nìj pou¾ít
<TT>tr</TT>. Pokud nìjaký text vzniká doplòováním hodnot do základního
øetìzce, doporuèuje dokumentace Qt pou¾ívat funkci <TT>QString::arg</TT>,
proto¾e ta umo¾òuje mìnit poøadí, v&nbsp;jakém se budou hodnoty do øetìzce vkládat.
Napø. hlá¹ení &bdquo;<EM>5 files deleted in directory /tmp</EM>&ldquo;
vygenerované pomocí

<PRE>
QString s(tr("%1 files deleted in directory %2"));
s&nbsp;= s.arg(5).arg("/tmp");
</PRE>

se dá pøelo¾it &bdquo;<EM>V adresáøi /tmp bylo smazáno 5 souborù</EM>&ldquo;
tím, ¾e definujeme jako èeský ekvivalent øetìzce <TT>"%1 files deleted in
directory %2"</TT> text <TT>"V adresáøi %2 bylo smazáno %1 souborù</EM>.

<P>Kdy¾ máme texty v&nbsp;programu pøipravené k&nbsp;pøekladu tím, ¾e jsme k&nbsp;nim pøidali
volání funkce <TT>tr</TT>, extrahujeme je utilitou <TT>lupdate</TT> do souboru
s&nbsp;pøíponou <TT>.ts</TT>. Pak u¾ v&nbsp;programu Qt Linguist pøekládáme jednotlivé
øetìzce. Soubor <TT>.ts</TT> je ve formátu XML, tak¾e kdo nechce pou¾ívat
Linguist, mù¾e se souborem pracovat v&nbsp;libovolném textovém editoru. Nakonec
pøíkazem <TT>lrelease</TT> vytvoøíme výsledné soubory øetìzcù (s&nbsp;pøíponou
<TT>.qm</TT>) pro jednotlivé jazyky.

<P>V aplikaci, typicky ve funkci <TT>main</TT>, musíme vytvoøit objekt
<TT>QTranslator</TT> a naèíst do nìj soubor øetìzcù pomocí
<TT>QTranslator::load</TT>. Pou¾ívání pøelo¾ených textù aktivujeme voláním
<TT>QApplication::installTranslator</TT>. Soubory <TT>.qm</TT> se obvykle
pojmenovávají tak, ¾e souèástí jména souboru je i kód jazyka. Aktuální jazyk,
nastavený v&nbsp;environmentové promìnné <TT>LANG</TT> (napø. <TT>cs_CZ</TT> pro
èe¹tinu), zjistíme metodou <TT>QTextCodec::locale</TT>.
</BODY>
</HTML>
