<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<P>X Window System (zkrácenì X) je standardní technologie pou¾ívaná
v&nbsp;unixových systémech pro tvorbu grafického u¾ivatelského rozhraní (GUI &ndash;
graphical user interface). U¾ivatelùm
Linuxu je dobøe známá implementace XFree86. V&nbsp;tomto seriálu èlánkù se budeme
zabývat programováním aplikací pro X, proto pøedpokládám, ¾e ètenáø má
u¾ivatelské znalosti prostøedí X a zná programovací jazyky C a C++. Probíraná
tématika vychází z&nbsp;mých stejnojmenných pøedná¹ek na MFF UK. Na webových
stránkách k&nbsp;pøedná¹ce
<A href="http://www.ms.mff.cuni.cz/~beran/vyuka/X/">http://www.ms.mff.cuni.cz/~beran/vyuka/X/</A>
lze najít dal¹í doplòující informace a sbírku krátkých ukázkových programù.

<P>Tento úvodní èlánek obsahuje seznámení s&nbsp;architekturou X a pøipomenutí
obecných principù pou¾ívaných pøi programování grafických rozhraní. Dal¹ích
nìkolik dílù seriálu bude vìnováno úvodu do toolkitu GTK+
(<A href="http://www.gtk.org/">http://www.gtk.org/</A>). Pak navá¾eme
popisem konkurenèního toolkitu Qt 
(<A href="http://www.trolltech.com/products/qt/index.html">http://www.trolltech.com/products/qt/index.html</A>). Závìr
bude patøit low-level knihovnì Xlib. Mo¾ná by byl logiètìj¹í obrácený postup
od Xlib k&nbsp;toolkitùm, nicménì takto se ètenáø døíve dozví informace potøebné
pro praktické programování aplikací pomocí toolkitù. Xlib je zajímavá z&nbsp;dùvodu
pochopení, jak X Window System funguje uvnitø, nicménì pou¾ívat pøímo tuto
knihovnu není moc obvyklé. A¾ si uká¾eme tøistaøádkový program
&bdquo;hello-world&ldquo;, uvidíme proè.

<P>X Window System se zaèal vyvíjet jako souèást projektu Athena v&nbsp;Laboratory
for Computer Science na MIT v&nbsp;roce 1983. Dal¹ím známým produktem projektu
Athena je autentizaèní systém Kerberos. V&nbsp;rychlém sledu následovaly verze X1
(1984) a¾ X11 (1987). Verze X10 Release 4 se stala základem pro první komerèní
implementace dodávané výrobci unixových pracovních stanic. Zatím poslední
verze je X11 Release 6.6 z&nbsp;roku 2001. Referenèní implementaci X spravuje The
Open Group &ndash; konsorcium pro otevøené systémy, které spravuje napø. i
standard pro OS Unix.

<H2>Architektura X</H2>

<P>Architektura X Window System je zalo¾ena na modelu klient-server. X server,
v&nbsp;terminologii X display, je poèítaè, ke kterému je pøipojena grafická
obrazovka, klávesnice a my¹. Dnes obvykle X server bì¾í na PC, døíve se
pou¾ívaly spí¹e unixové pracovní stanice nebo specializované X terminály, tj.
jednoúèelové poèítaèe na nich¾ je instalován pouze X server. Aplikace se
spou¹tí na jiných poèítaèích a X terminál s&nbsp;nimi komunikuje po síti. X klient
je program, který pou¾ívá slu¾by X serveru: zobrazování grafiky a zpracování
vstupu od u¾ivatele. Server a klient spolu komunikují pomocí socketù, mohou
tedy ka¾dý bì¾et na jiném poèítaèi v&nbsp;síti. Systém X Window je distribuovaný,
u¾ivatel mù¾e mít na jedné obrazovce okna programù bì¾ících na rùzných
poèítaèích a naopak aplikace z&nbsp;jednoho poèítaèe mohou komunikovat s&nbsp;u¾ivateli
prostøednictvím mnoha X serverù. Dal¹í dùle¾itou vlastností je otevøenost. X
se skládá z&nbsp;mnoha èástí komunikujících mezi sebou pøes standardizovaná
rozhraní. Proto mohou bez problémù spolupracovat implementace X od rùzných
výrobcù. Nìkteré èásti skládaèky (napøíklad toolkit nebo window manager) je
mo¾né vymìòovat a tím pøizpùsobit vzhled a chování systému potøebám a
zvyklostem konkrétního u¾ivatele.

<P>Klient a server si povídají X protokolem. Komunikace probíhá pøes sí»ové
(typicky TCP) sockety. Jestli¾e klient i server bì¾í na stejném poèítaèi,
pou¾ívají se lokální sockety (AF_UNIX) a pro pøenosy objemnìj¹ích dat i
sdílená pamì». Verzi protokolu vyjadøuje èíslo za písmenem X v&nbsp;názvu verze.
Protokol ji¾ dlouho zùstává nemìnný &ndash; od verze X11 Release 1 v&nbsp;roce
1987. Samozøejmì bylo od té doby potøeba do X pøidat nové funkce a u&nbsp;jiných
zmìnit jejich chování. Takové úpravy se provádìjí pomocí roz¹íøení
(extensions), která definují nová volání Xlib a nové typy zpráv X protokolu.
Pro roz¹íøení existuje definovaný systém registrace. Klient a server se
v&nbsp;rámci standardního X protokolu domluví, která roz¹íøení podporují.

<DIV align="center">
<P><IMG alt="Architektura X" src="xwin.png">
<P>Obr. 1: Architektura X
</DIV>

<P>Obrázek 1 zachycuje vztahy mezi hlavními èástmi celého systému X. Na jedné
stranì sítì je X server, jeho¾ architekturou se zde nebudeme dále zabývat.
Na¹ím cílem je programování v&nbsp;X, proto nás více zajímá, jak vypadá klient.
Teoreticky by aplikace (klient) mohla sama otevøít sí»ový socket a X
protokolem komunikovat se serverem. To ale nikdo nedìlá. Místo toho se pou¾ívá
knihovna Xlib, která poskytuje rozhraní ve formì funkcí v&nbsp;jazyce C a internì
zaji¹»uje komunikaci se serverem pomocí X protokolu. Xlib umo¾òuje provádìt
jen pomìrnì primitivní operace: vytvoøení okna, kreslení grafiky do okna a
pøíjem událostí, vzniklých napø. na základì akcí u¾ivatele.

<P>Pokud se pøímo pou¾ívají volání Xlib, musí se aplikace starat o&nbsp;spoustu
technických detailù. Nelze napø. v&nbsp;kódu napsat nìco jako: &bdquo;Vytvoø menu
s&nbsp;tìmito polo¾kami, a kdy¾ u¾ivatel vybere polo¾ku, generuj událost
s&nbsp;identifikátorem polo¾ky.&ldquo; Místo toho je tøeba nakreslit rámeèek menu, do
nìj napsat jednotlivé polo¾ky, detekovat kliknutí my¹i (pomocí zpracování
události), pøekreslit vybranou polo¾ku zvýraznìným stylem a teprve pak je
mo¾né provést akci iniciovanou výbìrem polo¾ky. Proto kód aplikace obvykle
nevolá Xlib, ale pou¾ívá toolkit &ndash; knihovnu, která poskytuje jednotlivé
prvky u¾ivatelského rozhraní (menu, tlaèítka, øádky pro vkládání textu,
apod.). Toolkit navenek poskytuje funkce na úrovni abstrakce odpovídající
na¹emu pøíkladu s&nbsp;menu. Programátor se u¾ nemusí starat o&nbsp;detaily vykreslování
a zpracování u¾ivatelského vstupu a mù¾e se zamìøit na logiku aplikace. Uvnitø
toolkit v&nbsp;implementaci svých funkcí pou¾ívá Xlib.

<P>V prostøedí X je ¾ádoucí provozovat i shell a dal¹í unixové programy, které
fungují v&nbsp;textovém re¾imu. K&nbsp;tomu se pou¾ívají emulátory terminálù (napø.
xterm), fungující na jednu stranu jako X-ový program. Na druhé stranì emulátor
pou¾ívá pseudoterminál a k&nbsp;nìmu pøipojí program bì¾ící v&nbsp;textovém re¾imu.

<P>Posledním dílkem mozaiky je window manager. Ten spravuje hlavní (top-level)
okna aplikací. Obvykle kolem ka¾dého top-level okna zobrazí rámeèek a umo¾òuje
u¾ivateli pomocí my¹i pøesouvat okna, mìnit jejich velikost a zavírat je.
Window manager také poskytuje menu pro spou¹tìní aplikací nebo je zapojen do
integrovaného desktopu (GNOME, KDE). Rozdìlení na low-level podporu pro tvorbu
GUI (Xlib), vlastní definici prvkù GUI (toolkit) a správu oken (window
manager) mù¾e sice mírnì sni¾ovat efektivitu, ale na druhou stranu poskytuje
velkou flexibilitu. Teoreticky mù¾e ka¾dá aplikace na obrazovce pou¾ívat jiný
toolkit. V&nbsp;rámci jednoho X serveru smí sice bì¾et jen jeden window manager,
ale u¾ivatel si mù¾e zvolit takový, jaký mu vyhovuje.

<H2>Spu¹tìní prostøedí X</H2>

<P>Ne¾ mù¾e u¾ivatel zaèít pracovat v&nbsp;prostøedí X Window System, je tøeba
nastartovat X server, window manager a pøípadnì poèáteèní sadu klientù, napø.
emulátor terminálu nebo skupinu aplikací tvoøící desktopové pracovní prostøedí. 
Existují tøi varianty, jak server a klienty spustit.

<P>První mo¾nost je samostatné ruèní spu¹tìní serveru ze shellu pøíkazem
<PRE>
$ X
</PRE>
a následnì klientù. Na jednom poèítaèi je mo¾né spustit nìkolik serverù. Ka¾dý
z nich bì¾í na samostatné virtuální konzoli. Klienti se po startu spojí s X
serverem specifikovaným v environmentové promìnné <TT>DISPLAY</TT> ve tvaru
<TT>[host]:display[.screen]</TT>. Èást pøed dvojteèkou je jméno poèítaèe s X
serverem (klienti se pøipojují pøes TCP socket). Kdy¾ jméno chybí, znamená to
lokální X server (klienti se pøipojují pøes unixový socket). Za dvojteèkou je
èíslo displeje, tj. X serveru. První X server má èíslo 0, pøi spu¹tìní dal¹ích
je nutné èíslo zadat:
<PRE>
$ X :1
</PRE>
Pokud X server pou¾ívá nìkolik monitorù, následuje za èíslem displeje teèka a
èíslo obrazovky, na které se mají objevit okna klienta.

<P>Dal¹í variantou nastartování prostøedí X je pøíkaz
<PRE>
$ startx [ [ client ] options ... ] [ -- [ server ] options ... ]
</PRE>
Program <TT>startx</TT> je skript. Administrátor ho mù¾e upravit podle
lokálních po¾adavkù. Standardnì vezme inicializaèní skript pro nastartování
klientù (u¾ivatelský <TT>$HOME/.xinitrc</TT> nebo systémový
<TT>/usr/X11R6/lib/X11/xinit/xinitrc</TT>) a serveru (u¾ivatelský
<TT>$HOME/.xserverrc</TT> nebo systémový
<TT>/usr/X11R6/lib/X11/xinit/xserverrc</TT>). Jména skriptù pøedá programu
<TT>xinit</TT>, který nastartuje server a následnì klienty. Po skonèení
posledního klienta <TT>xinit</TT> ukonèí server a skonèí. Èinnost
<TT>startx</TT> je schematicky znázornìna na obr. 2.

<DIV align="center">
<P><IMG alt="startx" src="startx.png">
<P>Obr. 2: Spu¹tìní prostøedí X pomocí <TT>startx</TT>
</DIV>

<P>Poslední zpùsob inicializace prostøedí X poskytuje u¾ivatelùm grafický
login do systému. Ze systémových inicializaèních skriptù je spu¹tìn display
manager &ndash; program <TT>xdm</TT> &ndash; s&nbsp;rootovskými právy. Display
manager nastartuje X server, inicializuje ho pomocí <TT>Xsetup</TT> a spustí
klienta <TT>xlogin</TT>. Ten pøeète jméno a heslo, ovìøí je a spustí
<TT>Xstartup</TT>. Následnì zmìní u¾ivatelskou identitu na novì nalogovaného
u¾ivatele. Skript <TT>Xsession</TT> pak nastartuje klienty. Po skonèení
posledního klienta konèí <TT>Xsession</TT>, display manager provede úklid
pomocí <TT>Xreset</TT> (ji¾ opìt s&nbsp;rootovskými právy), resetuje nebo
restartuje X server a celý cyklus se opakuje. Fungování <TT>xdm</TT> je
zobrazeno na obr. 3.

<DIV align="center">
<P><IMG alt="xdm" src="xdm.png">
<P>Obr. 3: Grafický login do prostøedí X pomocí <TT>xdm</TT>
</DIV>

<P>Klient má na serveru neomezená práva. Mù¾e manipulovat i s&nbsp;okny jiných
klientù a pøijímat z&nbsp;nich události. Proto je potøeba ne¾ádoucí
klienty zablokovat. V&nbsp;X existují dvì metody øízení pøístupu: xhost a xauth.
Pøíkaz <TT>xhost</TT> nastavuje v&nbsp;serveru seznam adres poèítaèù, ze kterých se
mohou pøipojovat klienti. Problém této metody je, ¾e z&nbsp;povoleného stroje mohou
server pou¾ívat v¹echny klientské programy, i kdy¾ patøí jinému u¾ivateli,
ne¾ který spustil X server. Øízení pøístupu pomocí
metody xhost se pou¾ívá, jestli¾e není zapnuta metoda xauth. Na poèátku jsou
povoleny jen lokální klientské aplikace. Kompletnì vypnout kontrolu pøístupu
lze pøíkazem
<PRE>
$ xhost +
</PRE>
nebo nastartováním serveru pomocí
<PRE>
$ X -ac
</PRE>
Metoda xauth funguje tak, ¾e server povolí pøipojení klienta, jestli¾e se
klient autentizuje klíèem. Pou¾íváno je nìkolik variant, nejèastìj¹í je
MIT-MAGIC-COOKIE-1. Pøi startu serveru program <TT>startx</TT> nebo
<TT>xdm</TT> vygeneruje náhodný klíè o&nbsp;délce 128 bitù a pøedá ho serveru.
Zároveò klíè ulo¾í do souboru <TT>.Xauthority</TT> v&nbsp;domovském adresáøi
u¾ivatele. Soubor je pøístupný jen pro vlastníka. Klient si pøed pøipojením
k&nbsp;serveru pøeète klíè z&nbsp;<TT>.Xauthority</TT> a po¹le ho serveru. Jestli¾e klíè
souhlasí, server klienta akceptuje. V&nbsp;souboru <TT>.Xauthority</TT> je mo¾né
pomocí pøíkazu <TT>xauth</TT> udr¾ovat klíèe nìkolika serverù. Autentizace
funguje zcela transparentnì z&nbsp;pohledu u¾ivatele i programátora, správný klíè
automaticky vybere a po¹le knihovna Xlib. Autentizaèní data i
ve¹kerá ostatní komunikace v&nbsp;rámci X protokolu jsou po síti posílány bez
jakékoliv ochrany a lze je odposlouchávat. Proto je v&nbsp;nedùvìryhodné síti
vhodné X-ovou komunikaci chránit napø. pomocí SSH. Pøíkaz
<TT>ssh</TT> umí vytvoøit ¹ifrovaný tunel a X protokol do nìj automaticky
pøesmìrovat.

<H2>Události a objekty</H2>

<P>Unixový program bì¾ící v&nbsp;textovém re¾imu (na terminálu) obvykle funguje
tak, ¾e pøeète kus dat ze vstupu, zpracuje je a po¹le výsledek na výstup. Pak
pøeète dal¹í èást vstupu a tak dále a¾ do konce vstupního souboru. Z&nbsp;logiky
programu plyne, kdy se bude èíst vstup a kdy generovat výstup. Takto fungují i
interaktivní programy, ve kterých vstup pochází z&nbsp;klávesnice a výstup je
vypisován na obrazovku.

<P>Programy, které mají grafické u¾ivatelské rozhraní, typicky pou¾ívají jiný
model &ndash; øízení událostmi. Akce u¾ivatele, jako stisk klávesy nebo pohyb
my¹í, jsou pøekládány na události. Událost je datová struktura obsahující typ
(napø. stisk tlaèítka my¹i) a dal¹í parametry (poloha my¹i a identifikátor
okna, v&nbsp;nìm¾ je kurzor). Program pøijímá události a volá pro nì obslu¾né
funkce &ndash; handlery. Jádrem událostmi øízeného kódu je cyklus zpracování
událostí. Detaily jsou v&nbsp;rùzných grafických prostøedích odli¹né, ale princip
je v¾dy stejný:
<PRE>
while(event = wait_for_event())
    process_event(event);
</PRE>
Zdrojem událostí není jen u¾ivatel. Události si mohou posílat i aplikace
navzájem. Nìkteré události generuje X server. Napøíklad kdy¾ je potøeba
nakreslit novì vytvoøené okno nebo pøekreslit èást okna, která byla pøedtím
zakrytá, server po¹le klientovi událost. V&nbsp;ní je specifikována oblast, která
se má vykreslit.

<P>Aby program promptnì reagoval na po¾adavky u¾ivatele, je nutné dodr¾ovat
nìkolik zásad. Ka¾dý handler by mìl bì¾et jen krátkou dobu a co nejdøív se
vrátit zpìt do cyklu zpracování událostí. Handler by nemìl volat systémové
funkce, které se mohou zablokovat, napø. èekání na data ze sítì. Pro takové
situace je k&nbsp;dispozici obdoba volání <TT>select</TT>. Proces si u&nbsp;správce
událostí zaregistruje deskriptor souboru. Kdy¾ je mo¾né èíst z&nbsp;deskriptoru
nebo na nìj zapisovat, je vygenerována událost. V&nbsp;handleru události se pak
volá neblokující operace ètení nebo zápisu. Existují i dal¹í mo¾nosti, jak
øe¹it situace, kdy je potøeba vykonat del¹í nebo potenciálnì blokující funkci.
Výpoèet se rozdìlí na krat¹í úseky a v&nbsp;rámci jednoho volání handleru se
provede jen jeden úsek. Handler se zaregistruje, aby se volal buï periodicky
po uplynutí urèitého èasového intervalu, nebo v¾dy, kdy¾ nejsou k&nbsp;dispozici
¾ádné události pro zpracování. Dlouhotrvající èinnosti se také dají pøesunout
do samostatného procesu nebo vlákna.

<P>Pøi programování GUI se s&nbsp;výhodou pou¾ívá objektovì orientované
programování. Ka¾dý prvek rozhraní (widget) je reprezentován jedním objektem.
Mezi tøídami widgetù je pøirozená hierarchie dìdiènosti daná podobností mezi
widgety. Koøenem hierarchie je obecný widget, který má definovanou napø.
velikost nebo handler zaji¹»ující nakreslení. Jedním z&nbsp;jeho potomkù je
tlaèítko. Z&nbsp;nìj je dále odvozený check box, li¹ící se vzhledem a tím, ¾e se
pøepíná mezi dvìma stavy. Radio button je skoro toté¾, jako check box, ale
vypadá trochu jinak a obvykle je prvkem skupiny obsahující v¾dy jen jedno
za¹krtnuté tlaèítko. Dal¹ím pøíkladem jsou widgety pro editaci textu a pro
zobrazení seznamu polo¾ek. Pro nì je spoleèná schopnost rolování, pokud obsah
pøesahuje viditelnou oblast widgetu. Sdílejí pøedka, který implementuje
spolupráci se scrollbary. Objektovì orientovaný toolkit nevy¾aduje
programovací jazyk s&nbsp;podporou objektù. Napø. GTK+ je celé napsané v&nbsp;C. Nicménì
uvidíme, jak implementace objektù v&nbsp;C prodlu¾uje a zeslo¾i»uje výsledný kód.
Rozdíl bude patrný pøi srovnání GTK+ a toolkitu Qt, který je napsaný v&nbsp;jazyce
C++. Objektovì orientovaný programovací jazyk tedy není nutností, ale je
znaènou výhodou.

<P>Øízení událostmi je v&nbsp;X pou¾ívané univerzálnì. Na událostech je zalo¾ené
GTK+, Qt, ostatní toolkity i knihovna Xlib. Na druhou stranu objektová
orientace je u¾iteèná, ale ne nutná. Toolkity jsou obvykle zalo¾ené na
objektech, ale Xlib objekty nepou¾ívá. Pokud se pracuje s&nbsp;objekty, je
oddìlená logická struktura u¾ivatelského rozhraní daná objekty (widgets)
uvnitø programu a reprezentace GUI viditelná u¾ivatelem reprezentovaná zdroji
(resources) X serveru &ndash; okna, fonty, grafické kontexty, atd.

<H2>Literatura</H2>

<OL>
<LI><EM>The Definitive Guides to the X Window System. O'Reilly &amp;
Associates</EM> &ndash; klasická série knih o&nbsp;X, popisuje X protokol, Xlib,
X Toolkit, toolkit Motif a pou¾ití prostøedí X z&nbsp;pohledu u¾ivatele a správce
<LI><EM>Havoc Pennington: GTK+/GNOME Application Development. New Riders
Publishing, 
<A href="http://developer.gnome.org/doc/GGAD/">http://developer.gnome.org/doc/GGAD/</A></EM>
&ndash; úvodní výklad programování v&nbsp;prostøedí GNOME a vybraná témata
o&nbsp;programování GTK+ (napø. vytváøení nových tøíd widgetù)
<LI><EM>Web toolkitu GTK+:
<A href="http://www.gtk.org/">http://www.gtk.org/</A></EM>
<LI><EM>Web desktopu GNOME:
<A href="http://www.gnome.org/">http://www.gnome.org/</A></EM>
<LI><EM>Web firmy Trolltech:
<A href="http://www.trolltech.org/">http://www.trolltech.org/</A></EM>
<LI><EM>Web desktopu KDE:
<A href="http://www.kde.org/">http://www.kde.org/</A></EM>
<LI><EM>Martin Beran: Programování pro X Window System. Pøedná¹ka na MFF UK
Praha, 
<A href="http://www.ms.mff.cuni.cz/~beran/vyuka/X/">http://www.ms.mff.cuni.cz/~beran/vyuka/X/</A></EM>
</OL>

<P>Stránky GTK+, GNOME, Trolltech a KDE obsahují zdrojové texty, u¾ivatelskou
a programátorskou dokumentaci, tutoriály i referenèní pøíruèky.
</BODY>
</HTML>
