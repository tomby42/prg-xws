<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System (10)</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<H2>Knihovna Xlib</H2>

<P>Knihovna Xlib zaji¹»uje elementární funkce X na stranì klienta. Aplikace se
typicky nepí¹í pouze s&nbsp;pou¾itím Xlib, proto¾e takové programování je znaènì
nepohodlné, jak uvidíme dále. Na rozdíl od toolkitù, Xlib neposkytuje widgety,
tj. hotové prvky u¾ivatelského rozhraní, které mají vlastní logiku, umí se
nakreslit a umí samy o&nbsp;sobì komplexnì reagovat na události. Napø. editaèní
øádek v&nbsp;GTK+ nebo Qt po stisku klávesy pøidá znak do interní reprezentace
zobrazeného textu, nakreslí ho na obrazovku a pomocí signálu dá vìdìt zbytku
aplikace o&nbsp;zmìnì svého stavu. V&nbsp;Xlib máme k&nbsp;dispozici pouze
funkce pro vytvoøení oken a manipulaci s&nbsp;nimi, pro kreslení a pro pøíjem
událostí. Implementace editaèního øádku bude vypadat tak, ¾e si aplikace
vytvoøí okno, nahraje font a bude pøijímat události. V&nbsp;reakci na
<TT>Expose</TT> pøekreslí okno a <TT>KeyPress</TT> zpùsobí pøidání znaku a
pøekreslení. Kdybychom chtìli dosáhnout stejné funkènosti, jakou poskytují
toolkity, museli bychom se postarat je¹tì o&nbsp;dal¹í vìci, jako napø.
cut&amp;paste.

<P>Xlib se pøíli¹ nehodí pro aplikaèní programování. Pøi psaní aplikace je
lep¹í pou¾ít vhodný toolkit. Obèas v¹ak mù¾e být nutné volat funkce Xlib pro
operace, které nemají podporu v&nbsp;toolkitu. Napø. historicky první X
Toolkit nemìl vlastní kreslicí operace a pro ve¹keré kreslení se pou¾ívaly
funkce z&nbsp;Xlib. Bez pou¾ití knihovny Xlib se samozøejmì neobejdou
programátoøi toolkitù. Ale i pro toho, kdo nikdy funkce Xlib pøímo nepou¾ívá,
je vhodné znát principy fungování této knihovny, aby pro nìj toolkit nebyl jen
èerná skøíòka.

<P>Základní náplní práce Xlib je pøeklad mezi C-èkovým API a zprávami X
protokolu. X protokol pou¾ívá streamový soket. Lokálnì se komunikuje pøes
unixový soket <TT>/tmp/.X11-unix/X<EM>d</EM></TT>, kde <TT><EM>d</EM></TT> je
èíslo displeje. Pro sí»ový pøístup k&nbsp;X serveru se pou¾ívá TCP soket na
portu 6000+<EM>d</EM>. Spojení v¾dy navazuje klient smìrem k&nbsp;serveru.
Pokud server podporuje Shared Memory Extension a klient i server jsou na
stejném poèítaèi, je mo¾né komunikaci urychlit tím, ¾e se nìkterá data
(obrázky) pøená¹í pøes sdílenou pamì».

<P>V X protokolu existují ètyøi typy paketù. <EM>Po¾adavky (requests)</EM>
posílá klient serveru. Generuje je vìt¹ina volání Xlib, napø. funkce pro
kreslení èáry, vytvoøení okna nebo dotaz na velikost okna. Pokud cílem
po¾adavku není získat nìjakou hodnotu od X serveru, server na po¾adavek
neodpovídá. Po¾adavky se neposílají jednotlivì, ale ukládají se do bufferu na
stranì klienta. Celý buffer se po¹le na server najednou, kdy¾ je plný. Obsah
bufferu se také posílá, jestli¾e program nemá ve frontì ¾ádnou èekající
událost a zavolá funkci Xlib pro èekání na událost (<TT>XNextEvent</TT>) nebo
jestli¾e se volá funkce, která vy¾aduje odpovìï od serveru. Tím je zaji¹tìno,
¾e ne¾ klient zaène èekat, server napø. vytvoøí a nakreslí okno, v&nbsp;nìm¾
chce aplikace pøijímat události. Poslední mo¾ností je explicitnì vynutit
okam¾ité odeslání bufferu po¾adavkù funkcemi <TT>XFlush</TT> nebo
<TT>XSync</TT>. To se hodí napø. pøi vykreslování animací, kdy je nutné
obnovit obsah okna v&nbsp;urèitý èas nezávisle na pøíchozích událostech.
Dávková komunikace se serverem se dá vypnout funkcí <TT>XSynchronize</TT>.
Xlib pak posílá ka¾dý po¾adavek ihned a èeká, zda server nevrátí chybu.
Synchronní re¾im není vhodné bì¾nì pou¾ívat, proto¾e je nìkolikanásobnì
pomalej¹í. Hodí se v¹ak pro ladìní, aby klient nedostával chyby asynchronnì a
se zpo¾dìním.

<P>Druhý typ paketù jsou <EM>odpovìdi serveru (replies)</EM> na nìkteré
po¾adavky klienta, napø. na dotaz o&nbsp;vlastnostech okna. Server klientovi
dále posílá <EM>události (events)</EM> informující o&nbsp;u¾ivatelském vstupu,
zmìnì rozlo¾ení oken, nebo obsahující zprávy od jiného klienta. Poslední typ
paketù jsou <EM>chyby (errors)</EM>, které informují o&nbsp;tom, ¾e se
nepovedl nìkterý z&nbsp;pøedchozích po¾adavkù. Díky dávkovému zpracování
po¾adavkù to nemusí být ten poslední. Chybu zachytí Xlib a zavolá na ni
chybový handler, jen¾ standardnì vypí¹e chybové hlá¹ení a ukonèí program.

<P>X server spravuje systémové zdroje poskytované klientùm pro pou¾ití
v&nbsp;jejich GUI. Typy zdrojù X serveru jsou: okno (window), pixmapa
(pixmap), paleta (colormap), kurzor (cursor), font a grafický kontext
(graphics context). Klienti se na nì odkazují pomocí èíselného identifikátoru
(ID). Tím, ¾e jsou data jako parametry oken, obrázky, znaky z&nbsp;fontu,
apod. ulo¾ena v&nbsp;pamìti serveru, redukuje se objem dat pøená¹ených mezi
klientem a serverem. S&nbsp;libovolným zdrojem X serveru mù¾e manipulovat
ka¾dý klient, který zná jeho ID. Program tak mù¾e kreslit nebo èíst
události v&nbsp;cizích oknech. Pøi odpojení klienta od serveru zru¹í X server
v¹echny zdroje vytvoøené odpojeným klientem.

<H2>Hello Xlib!</H2>

<P>Pro úvodní seznámení s&nbsp;funkcemi Xlib si jako obvykle pøedvedeme
program ve stylu &bdquo;Hello World&ldquo;. Program vytvoøí jediné okno a
v&nbsp;nìm nakreslí obdélník a vypí¹e nìkolik øetìzcù, viz obr. 1. Po stisku
klávesy nebo tlaèítka my¹i program skonèí. Celý zdrojový text je
v&nbsp;souboru <A href="hello.c">hello.c</A>. Soubor <A
href="hello_icon.h">hello_icon.h</A> obsahuje definici ikony. Program
pøelo¾íme a slinkujeme pøíkazem
<PRE>
gcc -o hello hello.c -I/usr/X11R6/include -L/usr/X11R6/lib -lX11
</PRE>
Tato varianta programu &bdquo;Hello World&ldquo; pochází z&nbsp;knihy
<EM>Adrian Nye: Xlib Programming Manual (O'Reilly and Associates, Inc.,
1992)</EM>. Ponìkud pøekvapující je délka programu 353 øádek. To je dost
znaèný rozdíl oproti programu pro GTK+ z&nbsp;2. dílu (91 øádek) a Qt ze 7.
dílu (14 øádek). Ji¾ toto srovnání cosi napovídá o&nbsp;(ne)vhodnosti Xlib pro
bì¾né aplikaèní programování. Z&nbsp;dùvodu velikosti programu ho zde nebudeme
podrobnì rozebírat øádek po øádku. 

<DIV align="center">
<P><IMG alt="Hello World" src="hello.png">
<P>Obr. 1: Hello World v&nbsp;Xlib
</DIV>

<P>Ve funkci <TT>main</TT> se klient nejprve pøipojí k&nbsp;X serveru voláním
<TT>XOpenDisplay</TT>. Po úspì¹ném navázání spojení vytvoøí okno pomocí
<TT>XCreateSimpleWindow</TT>. K&nbsp;oknu pøíslu¹í ikona vytvoøená funkcí
<TT>XCreateBitmapFromData</TT>. Dále je tøeba sdìlit window manageru (pomocí
<TT>XSetWMProperties</TT>) nìkteré informace o&nbsp;oknu, napø. titulek okna a
ikony, odkaz na pixmapu ikony a minimální velikost okna. Pøed zahájením
zpracování událostí je nutné øíct X serveru, které události má klientovi
posílat &ndash; <TT>XSelectInput</TT>. Pøed zahájením kreslení je tøeba naèíst
font funkcí <TT>XLoadQueryFont</TT>, vytvoøit grafický kontext funkcí
<TT>XCreateGC</TT> a nastavit jeho parametry: <TT>XSetFont</TT>,
<TT>XSetForeground</TT>, <TT>XSetLineAttributes</TT> a <TT>XSetDashes</TT>.
Následuje namapování (zobrazení) okna pomocí <TT>XMapWindow</TT>. Tím je
dokonèena inicializace programu a mù¾e být zahájen cyklus zpracování událostí.

<P>Program v¾dy poèká na událost a pøeète ji voláním <TT>XNextEvent</TT>. Pak
se rozhodne podle typu události (<TT>event.type</TT>). Událost <TT>Expose</TT>
je obslou¾ena nakreslením obsahu okna s&nbsp;vyu¾itím funkcí <TT>XDrawString</TT> a
<TT>XDrawRectangle</TT>. Událost <TT>ConfigureNotify</TT> informuje o&nbsp;zmìnì
velikosti okna a program na ni reaguje pøepoèítáním umístìní grafiky v&nbsp;oknì a
pøekreslením. Stisk klávesy (<TT>KeyPress</TT>) nebo tlaèítka my¹i
(<TT>ButtonPress</TT>) zpùsobí ukonèení programu. Pøed ukonèením se uvolní
alokované zdroje X serveru (<TT>XUnloadFont</TT>, <TT>XFreeGC</TT>) a klient
zavøe spojení se serverem (<TT>XCloseDisplay</TT>). Tyto úklidové akce nejsou
nezbytné, proto¾e ukonèení procesu zpùsobí zavøení soketu, které server
detekuje a uvolní ve¹keré zdroje alokované klientem. Nicménì je vhodné volat
alespoò <TT>XCloseDisplay</TT>, aby klient dostal pøípadné chyby, které mu
server zatím neposlal.

<H2>Okna</H2>

<P>Okno je obdélníková oblast na obrazovce, ve které lze kreslit a pøijímat
události. Pokud server a Xlib podporují roz¹íøení Shape, je mo¾né vytváøet
okna libovolných tvarù. Na ka¾dé obrazovce tvoøí okna stromovou strukturu.
Koøen stromu je koøenové (root) okno, existující po celou dobu bìhu X serveru.
Do root okna lze kreslit a lze v&nbsp;nìm pøijímat události, ale není mo¾né zmìnit
jeho velikost nebo pozici. Kromì vztahù pøedkù a potomkù (ancestors,
descendants) je ve stromì oken mezi sourozenci (synovskými okny stejného
rodièe) definován tzv. stacking order urèující, jak se tito sourozenci
navzájem zakrývají. Vztahy ve stromì oken jsou znázornìny na obr. 2.

<DIV align="center">
<P><IMG alt="strom oken" src="strom.png">
<P>Obr. 2: Strom oken a stacking order
</DIV>

<P>Souøadnice uvnitø okna se poèítají od levého horního rohu doprava a dolù.
Pozice okna se zadává relativnì vùèi rodièi. Okno mù¾e mít navíc okraj
(rámeèek). Poèátek souøadnic okna je v&nbsp;takovém pøípadì uvnitø rámeèku, av¹ak
pozice se vztahuje k&nbsp;bodu vnì rámeèku. Okraje oken se ale moc nepou¾ívají. Na
obr. 3 jsou zobrazeny jednotlivé rozmìry tvoøící geometrii oken.

<DIV align="center">
<P><IMG alt="geometrie oken" src="geometrie.png">
<P>Obr. 3: Geometrie oken
</DIV>

<P>Po vytvoøení existuje okno pouze jako datová struktura v&nbsp;pamìti X serveru.
Aby bylo vidìt na obrazovce, je nutné ho namapovat funkcí <TT>XMapWindow</TT>
a musí být namapování také v¹ichni jeho pøedci. Ani namapované okno nemusí být
vidìt, pokud le¾í mimo plochu svého rodièe nebo je zakryto svými sourozenci 
nebo sourozenci pøedkù. Okno se typicky neobjeví hned po zavolání
<TT>XMapWindow</TT>, proto¾e díky dávkové komunikaci se serverem mù¾e
po¾adavek nìjakou dobu èekat v&nbsp;bufferu klienta. U&nbsp;top-level oken navíc do
mapování vstupuje window manager. 

<P>Ka¾dé okno má sadu charakteristik, zadávaných pøi vytvoøení okna voláním
<TT>XCreateWindow</TT> nebo <TT>XCreateSimpleWindow</TT>. Pozdìji je lze
zji¹»ovat a nìkteré i mìnit pomocí funkcí Xlib (<TT>XReparentWindow</TT>,
<TT>XGetGeometry</TT>, <TT>XGetWindowAttributes</TT>,
<TT>XChangeWindowAttributes</TT>, atd.). Umístìní ve stromì oken a na
obrazovce urèují <EM>rodièovské okno</EM> a <EM>konfigurace okna</EM> (pozice,
¹íøka, vý¹ka, ¹íøka okraje a pozice v&nbsp;rámci stacking order). <EM>Visual</EM>
definuje zpùsob pøepoètu hodnot jednotlivých pixelù na barvy podle barevné
palety. Poèet bitù pou¾itých na ka¾dý pixel udává <EM>bitová hloubka</EM>.
Okno má <EM>tøídu</EM>, která mù¾e být <TT>InputOutput</TT> (do okna lze
kreslit a lze v&nbsp;nìm pøijímat události), nebo <TT>InputOnly</TT> (v&nbsp;oknì lze
pøijímat události, ale nelze do nìj kreslit a okno není vidìt).
<TT>InputOnly</TT> se hodí, pokud potøebujeme speciální obsluhu událostí nebo
jiný tvar kurzoru v&nbsp;urèité oblasti okna. Zde je tøeba zmínit, ¾e neexistují
¾ádná OutputOnly okna, proto¾e okno s&nbsp;libovolným grafickým obsahem musí
reagovat na po¾adavky serveru o&nbsp;pøekreslení, zasílané klientovi ve formì
událostí <TT>Expose</TT>. Poslední z&nbsp;charakteristik okna jsou
<EM>atributy</EM>.

<P>Atributù okna je celá øada. Dá se nastavit <EM>barva pozadí</EM> okna, nebo
lze alternativnì na pozadí umístit pixmapu. Pokud má okno okraj, dá se
nastavovat i jeho barva èi pixmapa. Hodnota <EM>bit gravity</EM> urèuje, co se
stane s&nbsp;obsahem okna pøi zmìnì velikosti. Standardní hodnota je
<TT>ForgetGravity</TT>, tj. okno se sma¾e a musí se pøekreslit. Dal¹í mo¾nosti
jsou znázornìny na obr. 4. Pùvodní obsah se zachová a pøesune se relativnì
vùèi poèátku okna. Pro nepokryté oblasti X server vygeneruje události
<TT>Expose</TT> a tím zajistí jejich vykreslení. Server nemusí bit gravity
implementovat a mù¾e v¾dy obsah okna celý smazat a nechat pøekreslit.
<EM>Window gravity</EM> øíká, co se má pøi zmìnì velikosti stát se synovskými
okny. Standardní je <TT>NorthWestGravity</TT>, tj. relativní poloha vùèi
poèátku okna se nemìní. Dal¹í mo¾nosti jsou <TT>UnmapGravity</TT> (synovská
okna se odmapují), <TT>StaticGravity</TT> (nemìní se poloha vzhledem ke
koøenovému oknu) a hodnoty z&nbsp;obr. 4. Hodnota <EM>backing store</EM> øíká,
zda si má X server pamatovat obsah okna, pokud je pøekryto jiným oknem. Po
odkrytí pak mù¾e okno obnovit bez toho, aby posílal událost <TT>Expose</TT>
klientovi. Duální funkci má atribut <EM>save under</EM>, který urèuje, zda si
má X server pamatovat obsah okna pøekrytého oknem s&nbsp;nastaveným save
under. To se hodí pro okna, která jsou na obrazovce zobrazena jen krátce, jako
napø. popup menu. Server nemusí backing store ani save under podporovat.
V&nbsp;ka¾dém oknì si mù¾e klient nastavit masku událostí, které chce
v&nbsp;tomto oknì pøijímat. Maska je samostatná pro ka¾dé okno a klienta, tudí¾
rùzní klienti mohou ve stejném oknì pøijímat rùzné mno¾iny událostí. Jestli¾e
má jednu událost vybranou více klientù, ka¾dý z&nbsp;nich dostane její kopii.
Události z&nbsp;my¹i a klávesnice, je¾ nejsou obslou¾eny v&nbsp;oknì, ve
kterém vznikly, se propagují smìrem ke koøeni. Propagace se zastaví, pokud
nìkteré okno na cestì událost pøijme, nebo událost dorazí do koøenového okna
nebo do okna, ve kterém je její propagace zakázána atributem
<EM>do_not_propagate_mask</EM>. Zobrazování a manipulace s&nbsp;top-level okny
je obvykle øízena window managerem. Nìkterá okna &ndash; popup menu, tooltipy,
apod. &ndash; se potøebují vyhnout interakci s&nbsp;window managerem, co¾
zaøídí atribut <EM>override_redirect</EM>. Zbývající atributy okna jsou
<EM>barevná paleta</EM> a <EM>tvar kurzoru</EM>.

<DIV align="center">
<P><IMG alt="gravity" src="gravity.png">
<P>Obr. 4: Bit a window ravity
</DIV>

</BODY>
</HTML>
