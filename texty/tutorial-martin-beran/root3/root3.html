<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System (3)</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<H2>Hierarchické uspoøádání widgetù a tøíd</H2>

<P>Widgety v&nbsp;GTK+ jsou hierarchicky uspoøádané. Existují dvì hierarchie &ndash;
widgetù a tøíd. Widgety v&nbsp;programu jsou uspoøádány do stromové struktury.
V&nbsp;koøeni stromu je v¾dy top-level okno. Je to vìt¹inou hlavní okno aplikace nebo
dialog. Program má tolik stromù widgetù, kolik má top-level oken. V&nbsp;uzlech 
stromu jsou widgety uvnitø top-level okna. V¹echny uzly kromì listù
jsou takzvané <EM>kontejnery</EM>, tedy widgety, do nich¾ lze vlo¾it dal¹í
jeden nebo více widgetù. Vzhled oken na obrazovce pøímo odpovídá hierarchii
widgetù. Okna potomkù le¾í v¾dy uvnitø okna rodièovského widgetu. Na obr. 1 je
pøíklad top-level okna programu a odpovídající strom widgetù je na obr2.

<DIV align="center">
<P><IMG alt="top-level okno" src="widgety1.png">
<P>Obr. 1: Pøíklad top-level okna
</DIV>

<DIV align="center">
<P><IMG alt="strom widgetù" src="widgety2.png">
<P>Obr. 2: Pøíklad stromu widgetù
</DIV>

<P>Obrázek 2 není úplnì pøesný, proto¾e objekty typu <TT>GtkButton</TT> a
<TT>GtkCheckButton</TT> nejsou pravé listy. Ve skuteènosti jsou to
kontejnerové widgety, které obvykle obsahují nápis typu <TT>GtkLabel</TT>.

<P>Hierarchie widgetù je v&nbsp;ka¾dém programu jiná a dynamicky se mìní podle
toho, jak vznikají a zanikají jednotlivé widgety. Druhý typ hierarchie je daný
vztahy dìdiènosti mezi tøídami widgetù. Spoleèným pøedkem v¹ech tøíd je
<TT>GObject</TT> definovaný ve stejnojmenné knihovnì. V&nbsp;knihovnì GTK+ je od
<TT>GObject</TT> odvozená tøída <TT>GtkObject</TT> a z&nbsp;ní dále
<TT>GtkWidget</TT>, co¾ je bázová tøída pro v¹echny widgety. Základ stromu
widgetù je v¾dy stejný, odli¹nosti vznikají, pokud program definuje vlastní
nové typy widgetù. Malý výøez hierarchie typù widgetù je na obr. 3.

<DIV align="center">
<P><IMG alt="strom tøíd" src="tridy.png">
<P>Obr. 3: Èást stromu tøíd widgetù
</DIV>

<H2>Manipulace s&nbsp;widgety</H2>

<P>Pro ka¾dou tøídu existuje jedna nebo více funkcí pro vytvoøení objektù této
tøídy. Napø. prázdné tlaèítko se vytvoøí voláním <TT>gtk_button_new</TT>.
Funkce <TT>gtk_button_new_with_label</TT> vyrobí tlaèítko s&nbsp;nápisem. Dal¹í
mo¾nosti jsou tlaèítko s&nbsp;akcelerátorem <TT>gtk_button_new_with_mnemonic</TT>
nebo pøeddefinované tlaèítko s&nbsp;nápisem a ikonou
<TT>gtk_button_new_from_stock</TT>. Zavoláním funkce pro vytvoøení widgetu
vznikne objekt uvnitø programu &ndash; X klienta. Aby byl widget vidìt na
obrazovce, je tøeba ho <EM>realizovat</EM>, tj. vytvoøit pro nìj GDK okno a
dále X okno, které existuje v&nbsp;X serveru. Realizaci provádí funkce
<TT>gtk_widget_realize</TT>. Následnì je widget zobrazen pomocí
<TT>gtk_widget_show</TT>, popø. <TT>gtk_widget_show_all</TT> zobrazí widget
vèetnì v¹ech potomkù. Tyto dvì funkce se postarají i o&nbsp;vytvoøení X oken, proto
není nutné explicitnì volat <TT>gtk_widget_realize</TT>. Existující widget lze
opakovanì zobrazovat a schovávat pomocí <TT>gtk_widget_show</TT> a
<TT>gtk_widget_hide</TT>. Existenci widgetu &ndash; vèetnì GDK a X okna &ndash;
ukonèí funkce <TT>gtk_widget_destroy</TT>.

<P>GTK+ pou¾ívá pøi správì pamìti poèítání referencí na objekty (reference
counting). U&nbsp;ka¾dého objektu se pamatuje poèet referencí na nìj, tedy poèet
ukazatelù na objekt. Pøi ulo¾ení odkazu na objekt do nìjakého ukazatele je
tøeba voláním funkce <TT>g_object_ref</TT> zvý¹it o&nbsp;1 poèet referencí. Naopak,
pokud se hodnota ukazatele zmìní, je nutné sní¾it poèet referencí pomocí
<TT>g_object_unref</TT>. Kdy¾ poèet referencí klesne na nulu, znamená to, ¾e
objekt nadále není dostupný pøes ¾ádný ukazatel. GTK+ takový objekt
automaticky zru¹í. Reference counting nefunguje dobøe pro cyklické datové
struktury. Jestli¾e existuje nìkolik objektù, které tvoøí cyklus vzájemných
odkazù, poèet referencí na ka¾dý objekt v&nbsp;cyklu je v¾dy aspoò jedna, i kdy¾
&bdquo;zvenku&ldquo; na ¾ádný z&nbsp;objektù neexistuje ¾ádný odkaz a datová
struktura jako celek je nedostupná. V&nbsp;takovém pøípadì je mo¾né nìkteré
ukazatele nezahrnovat do poètu referencí. Potom ov¹em pøi zru¹ení objektu
zbude neplatný ukazatel. Lep¹ím øe¹ením je pou¾ívání tzv. slabých referencí
(weak reference). Pøi nastavení hodnoty ukazatele se volá
<TT>g_object_weakref</TT>. Tím se zaregistruje funkce, která bude automaticky
zavolána pøi zru¹ení objektu. Tato funkce mù¾e napø. vynulovat ukazatel. Pøi
zmìnì hodnoty ukazatele je mo¾né odregistrovat slabou referenci voláním
<TT>g_object_weakunref</TT>.

<P>Mechanismus poèítání referencí ponìkud komplikují tzv. plovoucí reference.
Funkce pro vytvoøení widgetu vrátí ukazatel na objekt, který pøedstavuje
jednu referenci. Obvykle je nový widget následnì vlo¾en do kontejneru, který
pøidá dal¹í referenci. Pøi zru¹ení kontejneru vìt¹inou chceme automaticky
zru¹it i v¹echny v&nbsp;nìm vlo¾ené widgety. Abychom nemuseli v¾dy po vlo¾ení
widgetu do kontejneru volat <TT>g_object_unref</TT>, je první reference na
objekt vytvoøena jako <EM>plovoucí</EM> (floating). Kontejner tuto referenci
zru¹í pomocí <TT>gtk_object_sink</TT> poté, co pøidá vlastní referenci. Je
tøeba dávat pozor na to, ¾e pøi vyjmutí widgetu z&nbsp;kontejneru (funkcí
<TT>gtk_container_remove</TT>) zru¹í kontejner svou referenci. Pokud
nechceme, aby se vyjmutý widget zru¹il, musíme pøed voláním
<TT>gtk_container_remove</TT> pou¾ít <TT>g_object_ref</TT>. Takto vytvoøená
reference u¾ není plovoucí, proto zùstane platná i pøi opìtovném vlo¾ení
widgetu do kontejneru. Plovoucí je v¾dy pouze první reference na objekt. První
volání <TT>gtk_object_sink</TT> ji odstraní, opakovaná volání této funkce pro
stejný objekt u¾ nedìlají nic.

<H2>Kontejnery</H2>

<P>Kontejnery jsou widgety, do nich¾ lze vkládat jiné widgety (vèetnì dal¹ích
kontejnerù). V¹echny kontejnery vycházejí ze spoleèného pøedka
<TT>GtkContainer</TT>. Dají se rozdìlit do dvou hlavních skupin. Jednu skupinu
tvoøí tøídy odvozené z&nbsp;<TT>GtkBin</TT> a vyznaèují se tím, ¾e mohou obsahovat
maximálnì jeden synovský widget, pøístupný pøes polo¾ku <TT>GtkBin.child</TT>.
Asi nejdùle¾itìj¹ím zástupcem této skupiny je tøída <TT>GtkWindow</TT>, tedy
top-level okno. Do kontejnerù z&nbsp;druhé skupiny lze vlo¾it více widgetù. Jejími
nejpou¾ívanìj¹ími èleny jsou boxy (<TT>GtkHBox</TT> a <TT>GtkVBox</TT>)
obsahující widgety uspoøádané do øádku nebo sloupce a tabulky
(<TT>GtkTable</TT>), které umís»ují synovské widgety do dvojrozmìrné møí¾ky.

<P>Kontejnery zaji¹»ují automatické pøidìlování místa pro jednotlivé widgety.
Ne¾ se zobrazí top-level okno, zjistí GTK+ po¾adovanou velikost okna a v¹ech
jeho potomkù. K&nbsp;tomu se pou¾ívá metoda <TT>gtk_widget_size_request</TT>, která
vrátí minimální widgetem po¾adovanou velikost. Kontejnery mají tuto metodu
pøedefinovanou tak, ¾e se nejprve zavolá pro v¹echny synovské widgety a
z&nbsp;jejich po¾adavkù kontejner spoèítá, jak musí být velký, aby se do nìj v¹ichni
potomci ve¹li. Napø. horizontální box vrátí po¾adovanou ¹íøku rovnou souètu
¹íøek synovských widgetù plus velikost mezer podle parametrù boxu a vý¹ku
rovnou maximu vý¹ek synovských widgetù. Následnì GTK+ ve spolupráci s&nbsp;window
managerem nastaví velikost top-level okna. Skuteèná velikost se mù¾e li¹it od
po¾adované, napø. pokud u¾ivatel pomocí window manageru zmìnil rozmìry okna.
Nakonec GTK+ oznámí oknu skuteènì pøidìlenou velikost voláním metody
<TT>gtk_widget_size_allocate</TT>. V&nbsp;kontejnerech tato metoda rozdìlí oblast
widgetu mezi jednotlivé synovské widgety a výsledek rozdìlení jim oznámí opìt
voláním <TT>gtk_widget_size_allocate</TT>.

<P>Nìkteré funkce jsou spoleèné pro v¹echny kontejnery a jsou definované ve
tøídì <TT>GtkContainer</TT>.
<DL>
<DT>
<TT>void gtk_container_add(GtkContainer *container, GtkWidget *widget);</TT>
<DD>Vlo¾í widget do kontejneru. Obvykle se pou¾ívá pro kontejnery odvozené
z&nbsp;<TT>GtkBin</TT>. Ka¾dá kontejnerová tøída má navíc definované vlastní funkce
pro vkládání widgetù.
<DT>
<TT>void gtk_container_remove(GtkContainer *container, GtkWidget
*widget);</TT>
<DD>Odebere widget z&nbsp;kontejneru. Sní¾í o&nbsp;1 poèet referencí na widget, tak¾e
pokud jedinou referenci dr¾el kontejner, bude widget zru¹en.
<DT>
<TT>void gtk_container_set_border_width(GtkContainer *container,
guint border_width);</TT>
<DD>Nastaví ¹íøku okraje (v&nbsp;pixelech), tj. oblasti, do ní¾ nebudou zasahovat
vlo¾ené widgety.
<DT>
<TT>void gtk_widget_set_size_request(GtkWidget *widget, gint width, gint
height);</TT>
<DD>Nastaví minimální velikost widgetu. Bìhem procesu pøidìlování místa
widgetùm se bude rodièovský kontejner sna¾it nezmen¹it widget pod tuto
velikost. Funkce je definovaná pro v¹echny widgety, nejen kontejnery.
</DL>

<P><EM>Horizontální</EM> (<TT>GtkHBox</TT>) a <EM>vertikální</EM>
(<TT>GtkVBox</TT>) <EM>boxy</EM> jsou odvozené ze spoleèného pøedka
<TT>GtkBox</TT>. Pro vytvoøení boxu slou¾í funkce
<PRE>
GtkWidget* gtk_hbox_new(gboolean homogeneous, gint spacing);
GtkWidget* gtk_vbox_new(gboolean homogeneous, gint spacing);
</PRE>
Parametr <TT>homogeneous</TT> øíká, zda v¹echny synovské hodnoty budou stejnì
velké. Parametr <TT>spacing</TT> nastavuje velikost mezery (v&nbsp;pixelech)
ponechané mezi ka¾dou dvojicí widgetù. Pro vkládání widgetù do boxù jsou
definovány funkce
<PRE>
void gtk_box_pack_start(GtkBox *box, GtkWidget *child, gboolean expand,
			gboolean fill, guint padding);
void gtk_box_pack_end(GtkBox *box, GtkWidget *child, gboolean expand,
		      gboolean fill, guint padding);
</PRE>
První z&nbsp;nich vkládá widgety od levého/horního okraje boxu smìrem doprava/dolù,
druhá vkládá od pravého/dolního okraje smìrem doleva/nahoru. Parametr
<TT>expand</TT> øíká, zda widget mù¾e zabírat více místa ne¾ je jeho minimální
velikost. Pokud je nastaven na <TT>TRUE</TT> a <TT>fill</TT> je také
<TT>TRUE</TT>, bude widget zvìt¹en tak, aby zaplnil ve¹keré dostupné místo.
Pøi <TT>fill</TT> rovném <TT>FALSE</TT> nebude widget zvìt¹en a pøípadné
nadbyteèné místo se stane souèástí mezer kolem widgetu. Parametr
<TT>padding</TT> definuje ¹íøku prázdného místa po obou stranách widgetu.
Parametry ovlivòují pouze jeden rozmìr vkládaných widgetù. Vý¹ka v¹ech synù
hboxu, resp. ¹íøka synù vboxu, je stejná a je rovna vý¹ce (¹íøce) boxu
zmen¹ené o&nbsp;okraj.

<P>Význam jednotlivých parametrù boxu je zobrazen na obr. 4. Pro
experimentování s&nbsp;boxy lze vyu¾ít program <A href="boxes.c">boxes.c</A>, který
nejdøíve pøeète ze standardního vstupu specifikace boxu a jeho synovských
widgetù a následnì box zobrazí.

<DIV align="center">
<P><IMG alt="box" src="box.png">
<P>Obr. 4: Parametry boxu
</DIV>

<P><EM>Tabulka</EM> (<TT>GtkTable</TT>) se vytvoøí funkcí
<PRE>
GtkWidget* gtk_table_new(guint rows, guint columns, gboolean homogeneous);
</PRE>
Parametry definují poèet øádkù a sloupcù a zda v¹echna políèka tabulky mají
být stejnì velká. Pøi vkládání widgetù pomocí
<PRE>
void gtk_table_attach_defaults(GtkTable *table, GtkWidget *widget,
			       guint left_attach, guint right_attach,
			       guint top_attach, guint bottom_attach);
</PRE>
se definuje, ve kterých sloupcích a øádcích budou le¾et jednotlivé strany
widgetu. Existuje i funkce <TT>gtk_table_attach</TT>, která umo¾òuje
specifikovat je¹tì dal¹í parametry. Fungování tabulky si lze pøedstavit tak,
¾e sloupce a øádky jsou pevné tyèe, které se mohou volnì pohybovat, ale nesmí
si vymìnit poøadí. Jednotlivé widgety se pøipevòují svými okraji k&nbsp;tyèím.
Ka¾dý widget je gumový obdélník, mù¾e být libovolnì rozta¾en, ale nedá se
stlaèit pod svou minimální velikost. Po vlo¾ení v¹ech widgetù se tyèe
pøedstavující sloupce a øádky rozmístí tak, aby ¾ádný widget nebyl men¹í, ne¾
je jeho povolené minimum, a aby zároveò ¾ádný widget nebyl vìt¹í, ne¾ je
nezbytnì nutné. Na obr. 5 jsou vlevo znázornìny minimální velikosti ètyø
widgetù. Vpravo je tabulka, je¾ vznikne posloupností pøíkazù
<PRE>
table = gtk_table_new(3, 3, FALSE);
gtk_table_attach_defaults(table, widget1, 0, 3, 0, 1);
gtk_table_attach_defaults(table, widget2, 0, 1, 1, 3);
gtk_table_attach_defaults(table, widget3, 1, 2, 1, 2);
gtk_table_attach_defaults(table, widget4, 2, 3, 2, 3);
</PRE>

<DIV align="center">
<P><IMG alt="tabulka" src="tabulka.png">
<P>Obr. 5: Vytvoøení tabulky
</DIV>

<P>Automatické øízení rozmìrù a pozic widgetù je výhodné, proto¾e se
programátor nemusí zabývat pøesným umístìním jednotlivých widgetù. Navíc, kdy¾
u¾ivatel zmìní velikost okna, GTK+ na to zareaguje a rozumným zpùsobem upraví
rozmístìní widgetù v&nbsp;oknì. Pro seznámení s&nbsp;fungováním kontejnerù je u¾iteèné
spustit si program Glade a v&nbsp;nìm si vyzkou¹et vkládání widgetù do kontejnerù.
Jeho velkou výhodou je, ¾e lze interaktivnì mìnit parametry kontejnerù a
okam¾itì vidìt na obrazovce, jak se zmìní vzhled okna.

</BODY>
</HTML>
