<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System (11)</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<H2>Kreslení</H2>

<P>X Window System byl vyvíjen tak, aby mohl pou¾ívat ¹irokou ¹kálu grafických
karet a monitorù, od jednoduchých s&nbsp;nìkolika málo stupni ¹edi a¾ po
truecolor s&nbsp;24 i více bity barevné informace na pixel. Pou¾ívá bitmapovou
grafiku a barevná hodnota pixelu se v¾dy na výslednou barvu pøepoèítává
prostøednictvím barevné palety. Typ palety a zpùsob pøepoètu definuje visual.
Jako základní barevný model se pou¾ívá RGB, který je v¹ak device-dependent,
tj. stejnì zadaná barva mù¾e na rùzných monitorech vypadat jinak. Od verze
X11R5 je mo¾né pou¾ívat device-independent specifikace barev <EM>Xcms</EM> (X
Color Management System). Urèitá barva zadaná v&nbsp;nìkterém z&nbsp;Xcms barevných
prostorù by mìla vypadat stejnì na ka¾dém správnì zkalibrovaném monitoru.
Kromì zadání barvy pomocí hodnot jejích slo¾ek v&nbsp;nìkterém barevném prostoru je
mo¾né pou¾ívat jména barev. X má tabulku pro pøevod mezi jmény a hodnotami
barev.

<P>X rozli¹uje virtuální palety definované pro jednotlivá okna a fyzickou
paletu, kterou pou¾ívá grafický adaptér pro zobrazování. Window manager
instaluje virtuální palety do fyzické pomocí <TT>XInstallColormap</TT>.
Jestli¾e nelze souèasnì instalovat v¹echny virtuální palety, window manager se
sna¾í instalovat alespoò palety patøící aktuální aplikaci &ndash; typicky té,
v&nbsp;jejím¾ oknì je kurzor my¹i &ndash; a tím zajistit její správné zobrazení.
Okna ostatních aplikací pak mohou být zobrazena v&nbsp;nesprávných barvách.
Klient si alokuje polo¾ky palety voláním funkcí <TT>XAllocColor</TT>,
<TT>XAllocNamedColor</TT>, <TT>XcmsAllocColor</TT>, nebo
<TT>XcmsAllocNamedColor</TT>. V¾dy je potøeba zadat barvu a a funkce vrátí
index do palety, tj. hodnotu pixelu, kterou je potøeba pou¾ít pøi kreslení,
aby se zobrazila po¾adovaná barva. Takto alokované polo¾ky palet jsou
read-only, tzn. jejich barvu nelze dodateènì mìnit. Jejich výhoda je, ¾e mohou
být sdíleny nìkolika klienty. Pokud je paleta mìnitelná, dají se v&nbsp;ní alokovat
kromì read-only i read/write polo¾ky. Taková polo¾ka nemù¾e být sdílená.
Klient, který ji alokoval, mù¾e kdykoliv zmìnit její obsah a tím zmìnit
barvu v¹ech pixelù, je¾ byly nakresleny s&nbsp;hodnotou odpovídající indexu
této polo¾ky.

<P>Typy palet pou¾itelné na urèité obrazovce závisí na tom, jaké visuals
podporuje X server. Pro obrazovky schopné zobrazovat pouze stupnì ¹edi
existují tøídy visuals <EM>GrayScale</EM> (mìnitelná paleta) a
<EM>StaticGray</EM> (nemìnná paleta). Paleta je jednoslo¾ková, hodnota pixelu
se interpretuje jako index do palety a v&nbsp;polo¾ce palety se najde
odpovídající hodnota jasu. Barevné obrazovky s&nbsp;malou bitovou hloubkou
&ndash; nejèastìji 8 bitù &ndash; pou¾ívají tøídy visuals <EM>PseudoColor</EM>
(mìnitelná paleta) a <EM>StaticColor</EM> (nemìnná paleta). Paleta je opìt
jednoslo¾ková, ale polo¾ka palety se interpretuje jako 3 hodnoty pro barevné
slo¾ky R, G a B. Pøi pou¾ití velké bitové hloubky &ndash; napø. 24 bitù
&ndash; by jednoslo¾ková paleta byla pøíli¹ velká (2<SUP>24</SUP> polo¾ek).
Proto existují tøídy visual <EM>DirectColor</EM> (nemìnná paleta) a
<EM>TrueColor</EM> (mìnitelná paleta). Ty mají tøíslo¾kové palety. Hodnota
pixelu se rozdìlí na tøi èísla. Ka¾dé se pou¾ije jako index do jedné èásti
palety pro jednu barevnou slo¾ku. Výsledné hodnoty dají dohromady barvu. Pøi 8
bitech na ka¾dou slo¾ku je takto potøeba pouze 3.2<SUP>8</SUP> polo¾ek palety.
Na dne¹ních grafických kartách se typicky pou¾ívá visual TrueColor
s&nbsp;barevnou hloubkou 24 bitù, kdy hodnoty pixelù jsou stejné, jako obsah
pøíslu¹ných polo¾ek palety, tak¾e paleta pozbývá na významu.

<P>Mno¾ina grafických primitiv v&nbsp;X je relativnì malá, ale doplòují ji rùzná
roz¹íøení, napø. Render pro 2D grafiku vèetnì antialiasovaného textu a OpenGL
pro 3D grafiku. My se zde zamìøíme pouze na základní grafické mo¾nosti X bez
roz¹íøení. Kreslit se v&nbsp;X dá do tzv. <EM>drawables</EM>, co¾ jsou okna a
pixmapy. Pixmapa je bitmapový obrázek ulo¾ený na serveru. Obsah pixmapy se dá
zkopírovat do okna pomocí <TT>XCopyArea</TT> nebo <TT>XCopyPlane</TT>.

<P>Parametry kreslení se dr¾í na serveru v&nbsp;<EM>grafickém kontextu</EM>.
V&nbsp;po¾adavku na nakreslení grafického elementu se pak zadávají pouze souøadnice
bodù a ID grafického kontextu, ale nemusí se pøená¹et hodnoty v¹ech parametrù.
Grafický kontext se vytváøí funkcí <TT>XCreateGC</TT> a ru¹í funkcí
<TT>XFreeGC</TT>. Jeho obsah lze mìnit pomocí <TT>XChangeGC</TT> nebo
<TT>XCopyGC</TT>, popø. je mo¾né individuálnì nastavovat jednotlivé parametry:
<TT>XSetLineAttributes</TT>, <TT>XSetFileRule</TT>, <TT>XSetFunction</TT>,
atd. Hodnoty v&nbsp;grafickém kontextu se dají i èíst voláním
<TT>XGetGCValues</TT>. Zále¾í na konkrétní situaci, zda je lep¹í mít jeden
grafický kontext a mìnit jeho parametry, nebo si pøedem pøipravit nìkolik
rùznì nastavených grafických kontextù.

<P>Funkce <TT>XSetLineAttributes</TT> a <TT>XSetDashes</TT> nastavují
parametry èar. Základní parametr je tlou¹»ka èáry. Speciální hodnota 0 znamená
èáru o&nbsp;¹íøce 1 pixel kreslenou rychlej¹ím algoritmem ne¾ ostatní èáry. Èáry
s&nbsp;tlou¹»kou 0 se mohou na rùzných serverech li¹it, èáry s&nbsp;tlou¹»kou vìt¹í
vypadají v¹ude stejnì. Dále se zadává styl èáry: <TT>LineSolid</TT> (plná
èára), <TT>LineOnOffDash</TT> (pøeru¹ovaná èára) a <TT>LineDoubleDash</TT>
(èára kreslená støídavì barvou popøedí a pozadí). Druhý a tøetí styl pou¾ívají
definici délek úsekù pøeru¹ované èáry v&nbsp;parametrech <TT>dashes</TT> a
<TT>dash_offset</TT>. Mo¾nosti zakonèení èáry jsou na obr. 1. Varianta
<TT>CapNotLast</TT> funguje jen pro èáry ¹íøky 0 a 1. Pokud se jedním
po¾adavkem nakreslí nìkolik spojených èar, dá se nastavit zpùsob propojení
v&nbsp;místech napojení jednotlivých èar, viz obr. 2.

<DIV align="center">
<P><IMG alt="zakonèení èar" src="cap_style.png">
<P>Obr. 1: Zakonèení èar
</DIV>

<DIV align="center">
<P><IMG alt="spojení èar" src="join_style.png">
<P>Obr. 2: Spojení èar
</DIV>

<P>Pro kreslení textu je nutné v&nbsp;grafickém kontextu nastavit font pomocí
<TT>XSetFont</TT>. Pøed pou¾itím je nutné nahrát font funkcí
<TT>XLoadFont</TT>. Kdy¾ potøebujeme znát metriky jednotlivých znakù, mù¾eme
volat <TT>XLoadQueryFont</TT>. Ka¾dý font je v&nbsp;pamìti pouze jednou, server ho
uvolní z&nbsp;pamìti, kdy¾ ho v¹ichni klienti pøestanou pou¾ívat, tj. skonèí nebo
zavolají <TT>XFreeFont</TT> èi <TT>XUnloadFont</TT>.

<P>Pro kreslení vyplnìných polygonù je nutné specifikovat pravidlo pro
vyplòování (<TT>fill_rule</TT>). Varianty jsou <TT>EvenOddRule</TT> (bod je
vyplnìn, jestli¾e nekoneènì dlouhý paprsek vycházející z&nbsp;tohoto bodu protíná
obrys v&nbsp;lichém poètu prùseèíkù), nebo <TT>WindingRule</TT> (paprsek protíná
rùzný poèet levotoèivých a pravotoèivých segmentù obrysu). Rozdíl mezi tìmito
dvìma pravidly je vidìt na obr. 3. Dva zpùsoby vyplòování obloukù
(<TT>arc_mode</TT>) jsou ukázány na obr. 4.

<DIV align="center">
<P><IMG alt="vyplòování polygonù" src="fill_rule.png">
<P>Obr. 3: Vyplòování polygonù
</DIV>

<DIV align="center">
<P><IMG alt="vyplòování obloukù" src="arc_mode.png">
<P>Obr. 4: Vyplòování obloukù
</DIV>

<P>Standardnì se pøi kreslení provádí oøezávání podle obrysu okna, tj. nelze
kreslit mimo okno. Pomocí parametru <TT>subwindow_mode</TT> se dá zapnout
oøezávání i podle synovských oken (<TT>ClipByChildren</TT>, standardní
nastavení, kdy synovské okno le¾í na rodièi a zakrývá ho) nebo kreslení pøes
obsah synovských oken (<TT>IncludeInferiors</TT>). Oblast ovlivnìnou kreslením
lze dále redukovat nastavením oøezávací masky (<TT>clip_mask</TT>, funkce
<TT>XSetClipMask</TT>, <TT>XASetClipRectangles</TT> a <TT>XSetRegion</TT>). To
je bitmapa urèující, které pixely se budou pøekreslovat a které zùstanou
nezmìnìny. Pøíklad oøezávací masky je na obr 5, kde se z&nbsp;¹edého obdélníku
nakreslí jen tmavì ¹edá èást.

<DIV align="center">
<P><IMG alt="oøezávání" src="clip_mask.png">
<P>Obr. 5: Oøezávání
</DIV>

<P>Kreslení vyplnìných oblastí se øídí parametrem <TT>fill_style</TT>.
Nejjednodu¹¹í je vyplòování barvou popøedí (<TT>FillSolid</TT>) nastavenou
v&nbsp;parametru <TT>foreground</TT>. Druhá mo¾nost je pou¾ít pro vyplòování
pixmapu (<TT>FillTiled</TT>). Tøetí varianta (<TT>FillStippled</TT>) je
pou¾ití bitmapy (pixmapy s&nbsp;1 bitem na pixel). Kreslit barvou popøedí se
budou pouze ty pixely, je¾ mají v&nbsp;bitmapì hodnotu 1. Poslední zpùsob
vyplòování je <TT>FillOpaqueStipled</TT>, kdy se barvou popøedí kreslí pixely
s&nbsp;hodnotou 1 v&nbsp;bitmapì a barvou pozadí pixely s&nbsp;hodnotou 0. Ve
speciálních pøípadech je mo¾né zmìnou <TT>plane_mask</TT> nastavit, ¾e
kreslení bude pracovat jen s&nbsp;nìkterými bitovými rovinami okna. Normálnì
se stará hodnota pixelu zapomene a nahradí se novì kreslenou hodnotou. Je ale
mo¾né tyto dvì hodnoty zkombinovat po jednotlivých bitech. K&nbsp;dispozici je
v¹ech 16 existujících binárních funkcí dvou binárních promìnných.

<P>Xlib poskytuje funkce na kreslení jednotlivých bodù (<TT>XDrawPoint</TT>),
úseèek (<TT>XDrawLine</TT>), lomených èar (<TT>XDrawLines</TT>,
<TT>XDrawSegments</TT> a <TT>XFillPolygons</TT>), obdélníkù
(<TT>XDrawRectangle</TT>, <TT>XDrawRectangles</TT>, <TT>XFillRectangle</TT> a
<TT>XFillRectangles</TT>) a obloukù (<TT>XDrawArc</TT>, <TT>XDrawArcs</TT>,
<TT>XFillArc</TT> a <TT>XFillArcs</TT>). Funkce zaèínající na <TT>XDraw</TT>
kreslí jen obrysy. Funkce zaèínající na <TT>XFill</TT> kreslí vyplnìné
objekty. Poèet objektù, je¾ lze nakreslit jedním voláním, závisí na maximální
velikosti po¾adavku X protokolu. Toto maximum &ndash; udávané v&nbsp;jednotkách
o&nbsp;velikosti 4 bajty) se dá zjistit voláním <TT>XMaxRequestSize</TT>. Maximum
minus 3 udává maximální poèet bodù. Poèet úseèek a obdélníkù je polovièní,
poèet obloukù je tøetinový. Ve¹keré rozmìry se udávají v&nbsp;pixelech. Je nutné si
dávat pozor na to, ¾e stejnì zadané rozmìry znamenají pøi kreslení obrysù a
vyplnìných objektù nìco jiného, jak je znázornìno na obr. 6.

<DIV align="center">
<P><IMG alt="obrys a vyplnìní" src="obrys.png">
<P>Obr. 6: Obrys a vyplnìní
</DIV>

<P>X Window System podporuje 8bitové a 16bitové fonty. Kreslení øetìzcù
pomocí fontu nastaveného v&nbsp;grafickém kontextu provádí funkce
<TT>XDrawString</TT> a <TT>XDrawString16</TT>. Tyto funkce kreslí pouze
jednotlivé znaky barvou popøedí. Alternativnì lze pou¾ít
<TT>XDrawImageString</TT> a <TT>XDrawImageString16</TT>, které navíc kolem
textu nakreslí obdélník (bounding box) barvou pozadí. Nìkolik øetìzcù na
jednom øádku se dá nakreslit jedním voláním <TT>XDrawText</TT> nebo
<TT>XDrawText16</TT>. Pro ka¾dý øetìzec se specifikuje font a horizontální
posun vùèi konci pøedchozího øetìzce. Pozice textu pøi kreslení se zadává
pomocí souøadnic zaèátku úèaøí (baseline).

<P>V rámci podpory jiných jazykù ne¾ angliètiny se v&nbsp;X11R5 kromì jednoho
fontu dá pou¾ít i sada fontù (<TT>XFontSet</TT>), co¾ je mno¾ina fontù
obsahujících dohromady v¹echny znaky potøebné pro zobrazení textu v&nbsp;urèitém
locale (národním prostøedí). Pro zobrazení textu pøibyly funkce s&nbsp;prefixem
<TT>Xwc</TT>, je¾ pou¾ívají øetìzce typu <TT>wchar_t&nbsp;*</TT>, tj.
s&nbsp;vícebajtovými znaky s&nbsp;pevným poètem bajtù na ka¾dý znak. Dále pøibyly funkce
s&nbsp;prefixem <TT>Xmb</TT>. Ty pou¾ívají øetìzce typu <TT>char&nbsp;*</TT>, kde
mohou být rùzné znaky kódovány rùzným poètem bajtù. V&nbsp;XFree86 existují navíc
funkce s&nbsp;prefixem <TT>Xutf8</TT> pro práci s&nbsp;Unicode øetìzci v&nbsp;kódování UTF-8.
X11R6 pøineslo dal¹í zobecnìní zavedením výstupních metod.

<P>Seznam dostupných fontù lze zjistit pomocí <TT>XListFonts</TT> a
<TT>XListFontsWithInfo</TT>. Jména fontù se zadávají ve formì <EM>XLFD (X
Logical Font Description)</EM>. Ka¾dý font má jméno skládající se z&nbsp;èástí
oddìlených pomlèkami, napø.
<TT>-misc-fixed-bold-r-normal--13-120-75-75-c-70-iso8859-2</TT>. Jednotlivé
èásti jména definují vlastnosti fontu, napø. rodinu fontù (<TT>fixed</TT>),
velikost v&nbsp;pixelech (<TT>13</TT>), velikost v&nbsp;bodech (<TT>120</TT>) a kódování
(<TT>iso8859-2</TT>). Dají se pou¾ívat wildcardy, napø.
<TT>-*-*-medium-i-*--10-*-*-75-*-*-*-2</TT>. X server vybere první odpovídající
font. Pokud v&nbsp;seznamu získaném funkcí <TT>XListFonts</TT> nebo utilitou
<TT>xlsfonts</TT> narazíme na jméno fontu, které obsahuje nulovou velikost,
jedná se o&nbsp;¹kálovatelný font. Ve volání <TT>XLoadFont</TT> mù¾eme nulu
nahradit libovolným èíslem a tím nastavit potøebnou velikost fontu. Aby bylo
mo¾né vypisované texty správnì umístit na obrazovku, je nutné znát rozmìry
jednotlivých znakù &ndash; metriky fontu a v¹ech jeho znakù. Tyto informace je
mo¾né získat pomocí funkcí <TT>XQueryFont</TT> a <TT>XLoadQueryFont</TT> ve
formì struktur <TT>XFontStruct</TT> (metriky fontu) a <TT>XCharStruct</TT>
(metriky znakù). Význam metrických informací je vidìt na obr. 7.

<DIV align="center">
<P><IMG alt="metriky fontù" src="metriky.png">
<P>Obr. 7: Metriky fontù
</DIV>

</BODY>
</HTML>
