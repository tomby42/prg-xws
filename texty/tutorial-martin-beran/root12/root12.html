<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System (12)</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<H2>Zpracování událostí</H2>

<P>Událost v&nbsp;Xlib reprezentuje union <TT>XEvent</TT>. Sdru¾uje struktury
pro jednotlivé typy událostí. Zaèátek struktury ka¾dé události je stejný.
Obsahuje typ události, èíslo po¾adavku X protokolu, jen¾ vygeneroval událost,
pøíznak, zda událost vygeneroval X server nebo jiný klient funkcí
<TT>XSendEvent</TT>, displej a okno, kde událost nastala. Za tìmito polo¾kami
následují dal¹í polo¾ky v&nbsp;závislosti na typu události.

<P>X server generuje události a ukládá je do fronty. Události z&nbsp;fronty
server rozesílá klientùm. Kopii urèité události po¹le v¹em klientùm, kteøí
mají nastavený pøíjem tohoto typu událostí. Ka¾dý klient si vybírá typy
událostí samostatnì pro ka¾dé okno funkcí <TT>XSelectInput</TT>. Nepotøebné
typy událostí je mo¾né pøi zpracování prostì ignorovat, ale lep¹í je je
nevybírat, proto¾e pak je X server vùbec neposílá a ¹etøí se pøenosová
kapacita mezi serverem a klientem.

<P>Klient po úvodní inicializaci a vytvoøení oken obvykle zahájí cyklus
zpracování událostí, který vypadá zhruba takto:
<PRE>
while(1) {
    XNextEvent(display, &amp;event);
    switch(event.type) {
        case Expose:
            ...
        case ButtonPress:
            ...
        case MappingNotify:
            ...
        default:
            /* ignorované události */
    }
}
</PRE>
Funkce <TT>XNextEvent</TT> vrátí první událost z&nbsp;fronty. Pokud je fronta
prázdná, vyprázdní buffer po¾adavkù a èeká na pøíchod události. Xlib definuje
øadu dal¹ích funkcí pro neblokující ètení událostí nebo pro výbìr událostí
z&nbsp;fronty na základì rùzných kritérií, jako typ události, okno, nebo obecná
podmínka reprezentovaná boolovskou funkcí.

<P>Události z&nbsp;my¹i a klávesnice se doruèují do okna, v&nbsp;nìm¾ je
kurzor my¹i. Pokud toto okno nemá vybraný pøíslu¹ný typ události, propaguje se
událost smìrem k&nbsp;rodièovským oknùm. Distribuce událostí z&nbsp;klávesnice
dále závisí na nastavení <EM>keyboard focus</EM>. Pokud má nìkteré okno
nastavený focus, dostává ve¹keré události z&nbsp;klávesnice, které vzniknou
vnì tohoto okna. Uvnitø okna s&nbsp;focusem funguje doruèování událostí
normálnì, tj. událost dostane potomek, v&nbsp;nìm¾ je kurzor. Top-level oknùm
pøidìluje focus window manager. Aplikace, její¾ top-level okno dostalo focus,
jej mù¾e pøidìlit potomkùm top-level okna pomocí <TT>XSetInputFocus</TT>. Pøi
tom se generují události <TT>FocusOut</TT> a <TT>FocusIn</TT>. Alternativnì
mù¾e aplikace ponechat focus na top-level oknì a uvnitø nìho pou¾ívat pro
distribuci událostí z&nbsp;klávesnice nìjaký interní mechanismus. Tuto metodu
pou¾ívá napø. GTK+.

<P>Existují situace, kdy je potøeba zajistit, ¾e události z&nbsp;my¹i èi
klávesnice bude po urèitou dobu dostávat pouze jediný klient bez ohledu na to,
kde událost nastala. Takový klient si nastaví tzv. grab voláním
<TT>XGrabPointer</TT> nebo <TT>XGrabKeyboard</TT>. Opìtné uvolnìní my¹i a
klávesnice se provede funkcemi <TT>XUngrabPointer</TT> a
<TT>XUngrabKeyboard</TT>. Obvykle je potøeba, aby informaci o&nbsp;uvolnìní
tlaèítka my¹i dostalo stejné okno, ve kterém u¾ivatel tlaèítko stiskl. Proto X
server automaticky nastaví po stisku tlaèítka grab my¹i, pokud má klient
vybrané události <TT>ButtonPress</TT> i <TT>ButtonRelease</TT>. Nìkdy je nutné
po omezenou dobu vyhradit X server pro jediného klienta. Napø. nìkteré window
managery pøi interaktivním pøesunu nebo zmìnì velikosti okna kreslí prùbì¾nì
obrys okna a teprve nakonec pøekreslí celé okno. Aby nebylo tøeba pamatovat si
pùvodní hodnoty pixelù pøekrytých obrysem, kreslí se obrys pomocí kombinace
s&nbsp;pùvodní hodnotou pixelù operací XOR. Z&nbsp;vlastností XOR plyne, ¾e
opìtovné pøekreslení obnoví pùvodní hodnotu a tedy obrys sma¾e. To ale platí
jen tehdy, pokud se bìhem dvou kreslicích operací hodnoty pixelù nezmìní.
Proto pøed zahájením interaktivní manipulace s&nbsp;oknem window manager
zavolá <TT>XGrabServer</TT> a po definitivním umístìní okna uvolní grab pomocí
<TT>XUngrabServer</TT>. Mezi tìmito dvìma voláními X server nezprácováná ¾ádné
po¾adavky ostatních klientù. Obecnì platí, ¾e jakýkoliv grab by se mìl
pou¾ívat, pouze kdy¾ je to nezbytnì nutné.

<P>Události z&nbsp;klávesnice reprezentované strukturou <TT>XKeyEvent</TT>
obsahují kód stisknuté nebo uvolnìné klávesy (<TT>XKeyEvent.keycode</TT>) a
stav modifikátorù, tj. kláves jako Shift a Ctrl, v&nbsp;polo¾ce
<TT>XKeyEvent.state</TT>. Mapování mezi fyzickými klávesami a hodnotami
keycode je pevnì dané X serverem. Klient obvykle událost pøedá funkci
<TT>XLookupString</TT>. Ta pøevede keycode na <EM>keysym</EM> a na øetìzec.
Keysym je symbolická konstanta reprezentující klávesu, napø. <TT>XK_a</TT>
nebo <TT>XK_Page_Up</TT>. Tabulka pro mapování z&nbsp;keycode na keysym je
definovaná globálnì v&nbsp;X serveru. Dá se mìnit utilitami <TT>xmodmap</TT>
nebo <TT>setxkbmap</TT>. Druhá mo¾nost vyu¾ívá roz¹íøení XKB (X Keyboard
Extension), které poskytuje vìt¹í flexibilitu pøi definování rozlo¾ení
klávesnice ne¾ standardní obsluha klávesnice v&nbsp;X. Proto¾e pøevodní
tabulka je v&nbsp;serveru a pøevod na keysym dìlá klient, roze¹le server pøi
zmìnì rozlo¾ení klávesnice událost <TT>MappingNotify</TT>, na ni¾ klienti
zareagují aktualizací své kopie klávesové mapy pomocí
<TT>XRefreshKeyboardMapping</TT>. Standardní mapování z&nbsp;keysym na øetìzec
pøiøazuje klávesám generujícím platné znaky jednoznakové øetìzce. Ostatním
klávesám (¹ipky, funkèní klávesy) pøiøazuje prázdný øetìzec. Funkce
<TT>XRebindKeysym</TT> umo¾òuje zmìnit toto mapování lokálnì v&nbsp;rámci
jednoho klienta.

<P>Nìkteré jazyky mají slo¾itìj¹í schéma psaní znakù ne¾ 1 klávesa = 1 znak.
Jeden znak mù¾e být vytvoøen posloupností nìkolika stiskù kláves. Takové
skládání kláves øídí <EM>vstupní metody</EM> (<EM>input methods</EM>). Napø.
pro nìkteré asijské jazyky pou¾ívající písmo s&nbsp;velkým poètem znakù
u¾ivatel napí¹e název znaku v&nbsp;transkripci do latinky. Vstupní metoda mu
pøitom ve speciálním oknì zobrazuje aktuální stav a umo¾òuje editaci. Nakonec
se celý dlouhý název znaku pøekonvertuje na jediný znak a po¹le se aplikaci.
Dal¹ím pøíkladem je i èe¹tina. Obvyklá èeská klávesnice pou¾ívá mrtvé klávesy
pro èárku a háèek. Stisk mrtvé klávesy následovaný písmenem vygeneruje jediné
èárkované nebo háèkované písmeno. O&nbsp;slo¾ení dvou kláves do jednoho
písmene se opìt postará vstupní metoda. Zapojení vstupních metod do komunikace
mezi X serverem a klienty je zobrazeno na obr. 1. Klient A&nbsp;má jednoduchou
vstupní metodu implementovanou jako souèást Xlib. To mù¾e být pøípad èeských
mrtvých kláves. Klient B pou¾ívá komplexní vstupní metodu fungující jako
samostatný program napojený na server i klienta. Pro konverze znakù nebo tøeba
hledání znakù èi slov ve slovníku pou¾ívá vstupní metoda externí language
engine.

<DIV align="center">
<P><IMG alt="vstupní metody" src="im.png">
<P>Obr. 1: Vstupní metody
</DIV>

<P>Na stranì klienta je potøeba nastavit správné locale (<TT>setlocale(LC_ALL,
"")</TT>), otestovat, zda je podporované v&nbsp;Xlib
(<TT>XSupportsLocale</TT>) a nastavit pøípadné modifikátory
(<TT>XSetLocaleModifiers</TT>) podle environmentové promìnné
<TT>XMODIFIERS</TT>. Pak u¾ je mo¾né otevøít vstupní metodu (<TT>XOpenIM</TT>)
a vytvoøit vstupní kontext (<TT>XCreateIC</TT>). Bìhem zpracování událostí se
ka¾dá událost pøijatá funkcí <TT>XNextEvent</TT> nejprve pøedá vstupní metodì
pomocí <TT>XFilterEvent</TT> a podle návratové hodnoty klient buï událost
ignoruje, nebo ji dále zpracovává, napø. pomocí <TT>XLookupString</TT>.

<H2>Komunikace mezi programy</H2>

<P>X Window System obsahuje mechanismy pro komunikaci mezi klienty. Její
pravidla definuje dokument <EM>Inter-Client Communication Conventions Manual
(ICCCM)</EM>. Do tohoto manuálu je vhodné se v¾dy pøi pou¾ití nìkterého
komunikaèního mechanismu podívat na detaily jeho fungování. Komunikace je
zprostøedkovaná serverem, tak¾e klienti nemusí mít mezi sebou pøímé spojení.
Základním prostøedkem pro pøedávání dat jsou <EM>properties</EM>, co¾ jsou
jakési balíèky dat pøipojené k&nbsp;oknùm. Ka¾dé okno jich mù¾e nést nìkolik.
Property je identifikovaná jménem a èíslem okna. Jsou v&nbsp;ní ulo¾ena data a
jméno typu dat. Ka¾dý klient mù¾e mìnit libovolnou property. Server pøi zmìnì
property vygeneruje událost <TT>PropertyNotify</TT>.

<P>Jako jména properties a typù se pou¾ívají <EM>atomy</EM>. Atom je
jednoznaèný èíselný identifikátor. Zásadní problém takových identifikátorù
jsou kolize, kdy dva logicky rùzné identifikátory mají stejnou hodnotu.
Pravdìpodobnost kolizí se sní¾í pou¾íváním del¹ích identifikátorù, napø.
textových øetìzcù. Pou¾ívání textových identifikátorù by v¹ak zvìt¹ovalo objem
dat pøená¹ených mezi serverem a klientem. Øe¹ení pou¾ité v&nbsp;X funguje tak,
¾e ka¾dý atom má jméno. Klient pomocí <TT>XInternAtom</TT> po¹le serveru
øetìzec a server mu vrátí atom. Pokud je funkce <TT>XInternAtom</TT> volána
nìkolikrát se stejným øetìzcem, vrátí stejný atom. Pro rùzné øetìzce vrací
rùzné atomy.

<P>Funkce <TT>XSetWMProperties</TT> slou¾í pro nastavení standardní sady
properties, jimi¾ klient pøedává informace window manageru. Klient urèuje
titulek okna a ikony, obsah pøíkazového øádku pou¾itelného pro restart klienta
a jméno poèítaèe, kde klient bì¾í, dále ikonu a její poèáteèní pozici, omezení
velikosti okna, poèáteèní stav okna (normální/ikona), model pro pøidìlování
fokusu klávesnice a identifikátor skupiny top-level oken pøíslu¹ných ke stejné
aplikaci. Nastavením identifikátorù protokolù do property
<TT>WM_PROTOCOLS</TT> øíká klient, ¾e chce od window manageru dostávat
informace ve formì událostí <TT>ClientMessage</TT>. Protokol
<TT>WM_TAKE_FOCUS</TT> slou¾í ke sdìlení, kdy si aplikace smí nastavit focus
voláním <TT>XSetInputFocus</TT>. Pomocí protokolu <TT>WM_SAVE_YOURSELF</TT>
sdìluje session manager nebo window manager klientovi, aby ulo¾il svùj stav,
nebo» bude ukonèen. Kdy¾ klient pou¾ívá protokol <TT>WM_DELETE_WINDOW</TT> a
u¾ivatel zkusí zavøít okno prostøednictvím window manageru (obvykle kliknutím
na zavírací tlaèítko v&nbsp;rámeèku okna), pøedá window manager ¾ádost
o&nbsp;zavøení okna klientovi. Klient si mù¾e vy¾ádat potvrzení od u¾ivatele
nebo ulo¾it data a následnì buï okno zavøít, nebo ¾ádost ignorovat. Klient
nepou¾ívající <TT>WM_DELETE_WINDOW</TT> bude odpojen od X serveru, jakmile
u¾ivatel prostøednictvím window manageru zavøe nìkteré jeho top-level okno.

<P>Pro pøená¹ení dat mezi klienty se pou¾ívají výbìry (selections).
V&nbsp;Xlib se s&nbsp;nimi pracuje velmi podobnì jako v&nbsp;GTK+. Schéma
fungování výbìrù je na obr. 2. V¹imnìte si, ¾e vypadá témìø stejnì jako obr. 1
v&nbsp;5. dílu tohoto seriálu.

<DIV align="center">
<P><IMG alt="výbìry" src="selections.png">
<P>Obr. 2: Komunikace pomocí výbìrù
</DIV>

<P>Výbìrù lze definovat libovolnì mnoho, ale obvykle se pou¾ívá
<TT>XA_PRIMARY</TT>. Kdy¾ si u¾ivatel vybere nìjaká data, klient si pøivlastní
výbìr funkcí <TT>XSetSelectionOwner</TT>. Pøedchozí vlastník výbìru je
o&nbsp;tom informován událostí <TT>SelectionClear</TT>. Kdy¾ chce u¾ivatel
vlo¾it data do nìjakého okna, klient vlastnící toto okno zavolá
<TT>XConvertSelection</TT>. V&nbsp;parametrech zadá property, do ní¾ má
vlastník data vlo¾it, a po¾adovaný typ dat (target). Vlastník výbìru dostane
událost <TT>XSelectionRequest</TT> a v&nbsp;reakci na ni ulo¾í data do
property pomocí <TT>XChangeProperty</TT> a funkcí <TT>XSendEvent</TT> po¹le
pøíjemci dat událost <TT>SelectionNotify</TT>. Pøíjemce si pak data vyzvedne
voláním <TT>XGetWindowProperty</TT>.

<H2>Konfigurace aplikací</H2>

<P>Pro konfiguraci aplikací poskytuje Xlib funkce pro práci s&nbsp;tzv.
<EM>resource databází</EM>. Jednotlivé konfiguraèní hodnoty (resources) se pøi
startu programu ètou z&nbsp;nìkolika míst. V&nbsp;poøadí podle priority od
nejmen¹í po nejvìt¹í jsou to postupnì:
<OL>
<LI>Soubor <TT><EM>Classname</EM></TT> v&nbsp;adresáøi
<TT>/usr/X11R6/lib/X11/app-defaults</TT>. Zde <TT><EM>Classname</EM></TT> je
oznaèení tøídy aplikace, které je obvykle stejné jako jméno programu
s&nbsp;prvním nebo nìkolika prvními písmeny zmìnìnými z&nbsp;malých na velká,
napø. <TT>XTerm</TT> pro program <TT>xterm</TT>.
<LI>Soubor <TT><EM>Classname</EM></TT> v&nbsp;adresáøích zadaných
environmentovými promìnnými <TT>XUSERFILESEARCHPATH</TT> a
<TT>XAPPLRESDIR</TT>.
<LI>Properties <TT>RESOURCE_MANAGER</TT> root okna obrazovky 0 a
<TT>SCREEN_RESOURCES</TT> root oken jednotlivých obrazovek. Obsah tìchto
properties se obvykle nastavuje programem <TT>xrdb</TT> pøi startu
u¾ivatelského prostøedí X. Pokud nejsou nastavené, pou¾ije se soubor
<TT>.Xdefaults</TT> v&nbsp;domovském adresáøi.
<LI>Soubor zadaný environmentovou promìnou <TT>XENVIRONMENT</TT>, kdy¾ není
nastavená, pou¾ije se soubor <TT>.Xdefaults-<EM>hostname</EM></TT>
v&nbsp;domovském adresáøi.
<LI>Argumenty z&nbsp;pøíkazové øádky
</OL>

<P>Na zaèátku programu je nutné nejprve volat inicializaèní funkci
<TT>XrmInitialize</TT>. Jednotlivé èásti resource databáze se ètou pomocí
funkcí <TT>XrmParseCommand</TT>, <TT>XrmGetFileDatabase</TT> a
<TT>XrmGetStringDatabase</TT>. Nakonec se v¹e spojí do jediné databáze voláním
<TT>XrmMergeDatabases</TT>.

<P>Jednotlivé polo¾ky resource databáze jsou øádky tvaru <TT>jméno:
hodnota</TT>. Hodnota je øetìzec, do kterého je mo¾né pomocí escape sekvencí
vkládat libovolné znaky, napø. &bdquo;<TT>\n</TT>&ldquo; je konec øádku a
&bdquo;<TT>\123</TT>&ldquo; je znak s&nbsp;oktalovým èíslem 123. Zajímavìj¹í
je jméno polo¾ky. Skládá se z&nbsp;komponent oddìlených teèkami. Ka¾dá
komponenta je buï jméno tøídy zaèínající velkým písmenem, nebo jméno instance
zaèínající malým písmenem. V&nbsp;aplikacích pou¾ívajících X Toolkit
odpovídají jednotlivé komponenty úrovním stromu widgetù. V&nbsp;programech
postavených pøímo nad Xlib je mo¾né stromovou strukturu resource databáze
pou¾ít pro logické uspoøádání konfiguraèních hodnot. Místo libovolné
komponenty jména (kromì poslední), se dá pou¾ít wildcard otazník. Posloupnost
libovolnì mnoha komponent lze nahradit wildcardem hvìzdièka. Pøíklad úseku
resource databáze:

<PRE>
Fig.exportLanguage:         	  eps
.xf86cfg.geometry:                320x400
XCalc*hp.button1.horizDistance:   4
*Text.?.background:               rgb:29/44/94
</PRE>

<P>Pro hledání v&nbsp;databázi slou¾í funkce <TT>XrmGetResource</TT>. Jako
parametry dostane dvì kompletní jména polo¾ek bez wildcardù. Jedno jméno je
posloupnost jmen tøíd, ve druhém jsou pouze jména instancí. Funkce najde
v&nbsp;databázi nejlépe odpovídající polo¾ku a vrátí ji. Pokud se pøi
vytváøení databáze narazí na nìkolik polo¾ek s&nbsp;pøesnì stejným jménem,
ponechá se pouze poslední z&nbsp;nich. Jestli¾e zadanému klíèi odpovídá
nìkolik polo¾ek, porovnávají se po komponentách zleva doprava a v¾dy se
ponechají jen polo¾ky s&nbsp;nejvìt¹í prioritou. Porovnávání pokraèuje, dokud
nezùstane jediná polo¾ka. Pravidla pro priority zaji¹»ují, ¾e konkrétnìji
specifikovaná polo¾ka má pøednost pøed obecnou. Polo¾ka, která obsahuje
aktuálnì testovanou komponentu (<TT>*topLevel.quit.background</TT>,
<TT>*topLevel.Command.background</TT> a <TT>*topLevel.?.background</TT>) má
pøednost pøed polo¾kou, která komponentu pøeskakuje pomocí hvìzdièky
(<TT>*topLevel*background</TT>). Polo¾ka se jménem instance
(<TT>*quit.background</TT>) má pøednost pøed polo¾kou obsahující jméno tøídy
(<TT>*Command.background</TT>) a ta má pøednost pøed wildcardem otazník
(<TT>*?.background</TT>). Polo¾ka, pøed ní¾ je teèka
(<TT>*box.background</TT>), má pøednost pøed polo¾kou, kterou pøedchází
hvìzdièka (<TT>*box*Background</TT>).

<H2>Window manager</H2>

<P>Window manager je normální X klient, ale má speciální roli &ndash; spravuje
top-level okna ostatních klientù. Pro tento úèel mu Xlib poskytuje nìkolik
speciálních nástrojù. První je <EM>substructure redirection</EM>. Window
manager si v&nbsp;masce událostí root okna nastaví
<TT>SubstructureRedirectMask</TT>. Jestli¾e jiný klient zkusí namapovat svoje
top-level okno nebo zmìnit jeho pozici, velikost, ¹íøku okraje èi stacking
order, tato operace se nepovede a místo toho se window manageru po¹le událost
<TT>CirculateRequest</TT>, <TT>ConfigureRequest</TT>, nebo
<TT>MapRequest</TT> obsahující popis po¾adavku klienta. Window manager
následnì po¾adavek provede nebo zamítne. Nìkterá okna &ndash; napø. popup menu
a tooltipy &ndash; nejsou øízena window managerem. Pro taková okna je tøeba
nastavit atribut <TT>override_redirect</TT>.

<P>Vìt¹ina window managerù kreslí kolem jednotlivých top-level oken rámeèky.
Pro implementaci tìchto rámeèkù se vyu¾ívá <EM>reparenting</EM> oken. Kdy¾
window manager dostane událost <TT>MapRequest</TT>, vytvoøí rámeèek &ndash;
nové top-level okno, o&nbsp;trochu vìt¹í, ne¾ je okno aplikace. Pùvodní
top-level okno aplikace vlo¾í do rámeèku, tj. pomocí funkce
<TT>XReparentWindow</TT> zmìní jeho rodièe z&nbsp;koøenového okna na rámeèek.
Obì okna pak namapuje. 

<P>Tím, ¾e window manager vytvoøí nová rodièovská okna pro top-level okna
aplikací a obèas nìkterá okna odmapuje a místo nich zobrazí ikony, do¹lo by
pøi ukonèení window manageru ke zru¹ení v¹ech takových oken. Proto window
manager ukládá v¹echna spravovaná okna do <EM>save-set</EM> voláním
<TT>XAddToSaveSet</TT>. Pøi ukonèení window manageru X server automaticky v¹em
oknùm ze save-set zmìní rodièe zpìt na root okno a okna namapuje.

</BODY>
</HTML>
