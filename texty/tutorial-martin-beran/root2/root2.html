<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
</HEAD>

<BODY>
<H1>Programování pro X Window System (2)</H1>

<B>Martin Beran</B>
<EM>&lt;<A href="mailto:beran@ms.mff.cuni.cz">beran@ms.mff.cuni.cz</A>&gt;</EM>

<H2>GTK+</H2>

<P>Po minulém úvodním èlánku se teï u¾ opravdu pustíme do programování. První
toolkit, na který se podíváme blí¾, je GTK+. Zkratka pochází z&nbsp;názvu
&bdquo;The Gimp Toolkit&ldquo;. GTK+ toti¾ pùvodnì vzniklo jako toolkit pro
program Gimp. Dnes je na tomto toolkitu postaveno mnoho aplikací a tvoøí
základ desktopového prostøedí GNOME. Budeme se zabývat souèasnou stabilní
verzí GTK+ 2.2. Proti pøedchozí ¹iroce pou¾ívané verzi 1.2 obsahuje GTK+ 2
hodnì vylep¹ení, napø. lep¹í widgety pro seznamy, stromy, zobrazení a editaci
textu. Také se zlep¹ila kvalita dokumentace, nicménì stále zùstávají
nedokumentované funkce. Pro pochopení detailù je èasto nutné kombinovat
referenèní dokumentaci, tutoriály, ukázkové programy a zdrojové texty
toolkitu.

<P>Toolkit GTK+ je napsaný v&nbsp;jazyce C. Proto¾e je objektovì orientovaný,
bylo potøeba v&nbsp;C implementovat prostøedky pro manipulaci s&nbsp;objekty,
které jsou v&nbsp;jazycích jako C++ souèástí jazyka. Tøídy jsou definované
jako struktury, odvozená tøída obsahuje strukturu bázové tøídy jako svou první
polo¾ku. Virtuální metody jsou realizované pomocí signálù. Zde je tøeba
odli¹it unixové signály (asynchronní) a signály GTK+, které poskytují
mechanismus pro synchronní volání registrovaných handlerù. Pro GTK+ existují i
API (language bindings) pro jiné jazyky, ne¾ C. Podporované jsou Ada, C++,
Perl, Python, aj. V&nbsp;C++ lze pou¾ít buï C-èkové rozhraní, nebo knihovnu
gtkmm (døíve GTK--). Jednotlivé tøídy GTK+ jsou v&nbsp;gtkmm
&bdquo;obaleny&ldquo; tøídami jazyka C++. Grafické rozhraní programu se
definuje buï pøímo v&nbsp;kódu programu posloupností volání funkcí na
vytvoøení jednotlivých widgetù, nebo lze pou¾ít nástroj Glade pro vizuální
interaktivní návrh vzhledu aplikace. Programátor my¹í umís»uje jednotlivé
widgety na obrazovku a nastavuje jejich parametry. Glade následnì vygeneruje
kostru aplikace obsahující kód na vytvoøení widgetù. Do této kostry je pak
nutné doplnit zbytek programu, pøedev¹ím tìla handlerù signálù.

<P>Ne¾ se pustíme do programování, musíme si je¹tì ujasnit nìkolik základních
pojmù. <EM>Widget</EM> je prvek u¾ivatelského rozhraní (napø. check box nebo
editaèní textový øádek). V&nbsp;programu je reprezentovaný objektem tøídy
odvozené od <TT>GtkWidget</TT>. <EM>Objekt</EM> je instance tøídy
<TT>GObject</TT> nebo odvozené tøídy. Widget je také objekt, proto¾e
<TT>GtkWidget</TT> je potomkem <TT>GObject</TT>. <EM>Okno</EM> ve smyslu GTK+
je top-level okno programu (hlavní okno nebo dialog). Pomocná knihovna GDK,
která tvoøí rozhraní mezi GTK+ a Xlib, pou¾ívá termín okno pro strukturu
reprezentující X okno spravované X serverem. GDK okna existují
v&nbsp;klientovi. Naopak X okno je zdroj poskytovaný X serverem, klient si
dr¾í pouze jeho ID (èíselný identifikátor). Je to obdélníková oblast
obrazovky, do které mù¾e klient kreslit. Kdy¾ X server po¹le událost, je její
souèástí informace o&nbsp;tom, v&nbsp;kterém oknì nastala. Aby byl widget
vidìt na obrazovce, potøebuje X okno, do nìho¾ bude kreslit. Typicky má jeden
widget jedno GDK a tedy i jedno X okno. Korespondence 1:1 ale není nutná.
Widget mù¾e pou¾ívat nìkolik X oken. Naopak widgety, které nepotøebují
pøijímat události &ndash; napø. statický text &ndash; nemají vlastní X okno.
Pro kreslení pou¾ívají X okno rodièovského widgetu.

<P>X server posílá klientovi informace o&nbsp;aktivitì u¾ivatele ve formì
<EM>událostí</EM>. Události se zpracovávají asynchronnì. Pøíchozí událost je
ulo¾ena do fronty. Kdy¾ na ni nìkdy pozdìji pøijde øada, hlavní cyklus
zpracování událostí ve funkci <TT>gtk_main</TT> ji vyzvedne a zpracuje.
Widgety komunikují pomocí <EM>signálù</EM>. Kdy¾ se s&nbsp;widgetem stane nìco
dùle¾itého, na co je potøeba reagovat (napø. u¾ivatel vybere polo¾ku menu),
widget emituje signál voláním <TT>g_signal_emit_by_name</TT>. Následnì jsou
postupnì zavolány v¹echny handlery registrované pro danou dvojici zdrojový
widget, typ signálu. Signály se zpracovávají synchronnì &ndash; funkce
emitující signál zavolá v¹echny pøíslu¹né handlery a teprve pak se vrátí.
Události jsou funkcí <TT>gtk_main</TT> pøelo¾eny na signály a následnì
obslou¾eny. Handlery signálù dostávají jako parametr widget, který signál
emitoval, a ukazatel nastavený pøi registraci handleru funkcí
<TT>g_signal_connect</TT>. Nìkteré typy signálù pou¾ívají dal¹í parametry.
Napøíklad handler událostí dostává strukturu popisující událost. Handlery
mohou mít i návratovou hodnotu. Handlery událostí vrací boolovskou hodnotu.
TRUE znamená, ¾e událost byla obslou¾ena a není tøeba volat dal¹í handlery.
Kdy¾ handler vrátí FALSE, událost se pøedá dal¹ímu handleru v&nbsp;poøadí. GTK+
nekontroluje, zda má handler správné typy parametrù a návratové hodnoty.
Pokud programátor pou¾ije ¹patný typ handleru, obvykle to skonèí havárií
programu.

<H2>Hello World!</H2>

<P>Pøi výkladu nového programovacího jazyka nebo nástroje se obvykle zaèíná
triviálním programem ve stylu &bdquo;hello world&ldquo;. Ani my neudìláme
výjimku. Celý zdrojový kód programu je v&nbsp;souboru <A
href="hello.c">hello.c</A>. Program otevøe okno s&nbsp;tlaèítkem a po
stisknutí tlaèítka skonèí.

<P>Na zaèátku je potøeba naèíst hlavní hlavièkový soubor GTK+. Ten zajistí
naètení v¹ech dal¹ích potøebných hlavièkových souborù GTK+ a podpùrných
knihoven.
<PRE>
#include &lt;gtk/gtk.h&gt;
</PRE>
Funkce <TT>main</TT> musí na zaèátku inicializovat toolkit
pomocí
<PRE>
gtk_init(&amp;argc, &amp;argv);
</PRE>
Této funkci se pøedávají parametry z&nbsp;pøíkazového øádku. GTK+ odebere
parametry, které zná, napø. <TT>--display</TT> (jméno X serveru, ke kterému se
má pøipojit), <TT>--no-xshm</TT> (nebude se pou¾ívat sdílená pamì» pro
komunikaci s&nbsp;lokálním X serverem), nebo <TT>--sync</TT> (synchronní
komunikace s&nbsp;X serverem pou¾ívaná pro ladìní). Funkce <TT>gtk_init</TT>
inicializuje objektový systém GTK+ a musí se volat jako první funkce toolkitu.

<P>Následuje vytvoøení top-level okna
<PRE>
window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
</PRE>
Parametr <TT>GTK_WINDOW_TOPLEVEL</TT> znamená, ¾e okno dostane rámeèek a bude
spravováno window managerem. 
Hlavní okno bude mít pøipojené dva handlery signálù.
<PRE>
g_signal_connect(G_OBJECT(window), "delete_event",
                 G_CALLBACK(delete_event), NULL);
g_signal_connect(G_OBJECT(window), "destroy",
                 G_CALLBACK(destroy), NULL);
</PRE>
Pøi registraci handlerù se zadává dvojice objekt a jméno signálu, pro kterou
se handler registruje. Následuje handler a hodnota, pøedávaná handleru jako
poslední parametr. Handler dostane ukazatel na objekt jako první parametr. Za
ukazatelem na objekt mohou je¹tì následovat parametry specifické pro urèitý
signál. Ve volání <TT>g_signal_connect</TT> se objevuje charakteristický rys
GTK+ &ndash; volání pøetypovacích maker. Makro <TT>G_OBJECT</TT> pøetypuje
parametr na <TT>GObject</TT>. Pro ka¾dou tøídu existuje makro, které dostane
ukazatel, zkontroluje, zda lze pøetypovat a vrátí pøetypovaný ukazatel nebo
vypí¹e chybové hlá¹ení. Takto se vìt¹inou pøetypovává nìjaký objekt na objekt
pøedka, co¾ se v&nbsp;C++ dìje automaticky. C nezná hierarchii dìdiènosti a
odvozená tøída, i kdy¾ obsahuje objekt zdìdìné tøídy na zaèátku struktury, je
pro pøekladaè jiný typ a pøetypování je nutné explicitnì napsat.

<P>Událost <TT>delete_event</TT> vygeneruje window manager, kdy¾ u¾ivatel
stiskne zavírací tlaèítko na rámeèku okna. Obvyklá reakce na tuto událost je
taková, ¾e se program zeptá u¾ivatele, zda chce skonèit a popøípadì ulo¾it na
disk neulo¾ená data. Kdy¾ u¾ivatel potvrdí ukonèení programu, handler vrátí
<TT>FALSE</TT> a tím umo¾ní pokraèování zpracování události. Kdy¾ nejsou
pøipojené dal¹í handlery, vyvolá se standardní obsluha, která zru¹í top-level
okno. Jestli¾e se u¾ivatel rozhodne, ¾e se program nemá ukonèit, handler vrátí
<TT>TRUE</TT>, událost je tím obslou¾ena a dal¹í handlery se nevolají. Handler
na¹eho &bdquo;hello world&ldquo; pouze vypí¹e hlá¹ení na standardní výstup a
nechá program pokraèovat.
<PRE>
static gint delete_event(GtkWidget *widget, GdkEvent *event, gpointer data)
{
    g_print("delete event occurred\n");
    return TRUE;
}
</PRE>

<P>Widget generuje signál <TT>destroy</TT> pøi svém zru¹ení. Kdy¾ je zavøeno
hlavní okno aplikace, je potøeba pøeru¹it zpracování událostí. Jinak by sice
program zmizel z&nbsp;obrazovky, ale bì¾el by dál. O&nbsp;ukonèení se postará
handler
<PRE>
static void destroy(GtkWidget *widget, gpointer data)
{
    gtk_main_quit();
}
</PRE>

<P>V dal¹ím kroku vytvoøíme tlaèítko s&nbsp;nápisem &bdquo;Hello World&ldquo; a
vlo¾íme ho do okna.
<PRE>
button = gtk_button_new_with_label("Hello World");
g_signal_connect_swapped(G_OBJECT(button), "clicked",
                         G_CALLBACK(gtk_widget_destroy), G_OBJECT(window));
gtk_container_add(GTK_CONTAINER(window), button);
</PRE>
Kdy¾ u¾ivatel stiskne tlaèítko, a» u¾ s&nbsp;pou¾itím klávesnice nebo my¹i, je
vygenerován signál <TT>clicked</TT>. Jako handler jsme nastavili funkci
<TT>gtk_widget_destroy</TT>, která zru¹í widget zadaný jako parametr. Proto¾e
chceme zru¹it celé okno a ne jenom tlaèítko, voláme
<TT>g_signal_connect_swapped</TT>. Tato funkce funguje podobnì jako
<TT>g_signal_connect</TT>, ale závìreèný parametr se pøedává handleru jako
první a ukazatel na objekt, který emitoval signál, jako poslední parametr.
O&nbsp;parametry funkce se v&nbsp;C stará volající, proto nevadí, ¾e handler má jen jeden
parametr a pøi volání dostane dva. Dùle¾ité je, ¾e souhlasí typ prvního
parametru. Podobnì bychom nemuseli definovat handler <TT>destroy</TT> a místo
nìj bychom pøipojili pøímo funkci <TT>gtk_main_quit</TT>.

<P>Ka¾dý widget musíme zobrazit, jinak by sice existoval jako objekt
v&nbsp;programu, ale nebyl by vidìt na obrazovce.
<PRE>
gtk_widget_show(button);
gtk_widget_show(window);
</PRE>
Místo volání <TT>gtk_widget_show</TT> pro ka¾dý widget mù¾eme zobrazit widget
a v¹echny v&nbsp;nìm obsa¾ené widgety funkcí <TT>gtk_widget_show_all</TT>.
Pøedchozí dva øádky bychom mohli zmìnit na
<PRE>
gtk_widget_show_all(window);
</PRE>
Nakonec spustíme zpracování událostí
<PRE>
gtk_main();
</PRE>
Kdy¾ je tato funkce ukonèena pomocí <TT>gtk_main_quit</TT> v&nbsp;handleru 
<TT>destroy</TT> volaném pøi zavøení okna, ukonèíme program návratem
z&nbsp;funkce <TT>main</TT>.

<H2>Pøeklad a linkování programu</H2>

<P>Ná¹ první program v&nbsp;GTK+ pøelo¾íme pøíkazem
<PRE>
gcc -o hello `pkg-config --cflags --libs gtk+-2.0` hello.c
</PRE>
Utilita <TT>pkg-config</TT> se postará o&nbsp;správné nastavení kompilátoru a
linkeru. Kdy¾ se zavolá s&nbsp;pøepínaèem <TT>--cflags</TT>, vrátí seznam cest,
kde jsou hlavièkové soubory pro GTK+ nebo pro jinou knihovnu, její¾ jméno je
zadané jako poslední parametr. Verze GTK+ 2.2 opravuje chyby pøedchozí verze
2.0 a jinak je s&nbsp;ní kompatibilní, proto v&nbsp;<TT>pkg-config</TT> obì
verze pou¾ívají název <TT>gtk+-2.0</TT>. Seznam cest se vypisuje ve tvaru
direktiv kompilátoru <TT>-I</TT><EM>adresáø</EM>. Pøepínaè <TT>--libs</TT>
zpùsobí vypsání seznamu potøebných knihoven a adresáøù, kde jsou knihovny
ulo¾eny (direktivy <TT>-L</TT><EM>adresáø</EM> a
<TT>-l</TT><EM>knihovna</EM>).

<P>Pro øízení pøekladu vìt¹ích programù slo¾ených z&nbsp;více zdrojových
modulù se obvykle pou¾ívá utilita <TT>make</TT>. Úsek <TT>Makefile</TT> pro
ná¹ první program v&nbsp;GTK+ by vypadal nìjak takto:
<PRE>
CC=gcc
CFLAGS=`pkg-config --cflags gtk+-2.0`
LIBS=`pkg-config --libs gtk+-2.0`

hello: hello.o
	$(CC) -o hello $(LIBS) hello.o

hello.o: hello.c
	$(CC) $(CFLAGS) -c hello.c
</PRE>

<H2>Knihovny pou¾ívané v&nbsp;GTK+</H2>

<P>Na obr. 1 jsou schematicky znázornìny vztahy mezi hlavními knihovnami.

<DIV align="center">
<P><IMG alt="knihovny" src="knihovny.png">
<P>Obr. 1: Knihovny v&nbsp;GTK+
</DIV>

<P>Nad základní klientskou knihovnou Xlib le¾í vrstva GDK (GTK Drawing Kit).
Takto knihovna obaluje volání Xlib a má dvì hlavní funkce. Za prvé ponìkud
zjednodu¹uje komplikované API Xlib a za druhé usnadòuje pøenositelnost na jiné
grafické systémy ne¾ X (napø. MS Windows nebo linuxový frame buffer), proto¾e
se mìní pouze implementace funkcí GDK a nikoliv API. Proto mohou vy¹¹í vrstvy
toolkitu zùstat témìø nezmìnìné. Dal¹í vrstvu tvoøí vlastní toolkit GTK+.
Skládá se z&nbsp;implementace objektového systému, podpory zpracování událostí
a signálù a tøíd pro jednotlivé widgety. Aplikace volá funkce z&nbsp;GTK+.
Pokud potøebuje pøímo kreslit vlastní grafiku, definovat nové tøídy widgetù
nebo provádìt speciální operace s&nbsp;okny, mù¾e volat i GDK. Mezi knihovnami
GTK+ a GDK le¾í je¹tì theme engine. Je v&nbsp;ní definován vzhled jednotlivých
widgetù. Implementace widgetù v&nbsp;GTK+ nevolají pøímo funkce pro kreslení
grafických primitiv (napø. èar nebo obdélníkù) z&nbsp;GDK. Místo toho volají
funkce z&nbsp;theme, které kreslí slo¾itìj¹í objekty, napø. celé tlaèítko.
Theme engine pøekládá tyto komplexní kreslicí operace do série grafických
primitiv. Výmìnou této knihovny &ndash; i za bìhu programu &ndash; lze mìnit
celkový vzhled u¾ivatelského rozhraní.

<P>Balík GTK+ obsahuje tyto hlavní knihovny:
<UL>
<LI><B>GLib</B> (<TT>-lglib-2.0</TT>) ... pomocné funkce a datové struktury
<LI><B>GDK</B> (<TT>-lgdk-x11-2.0</TT>) ... wrapper funkcí Xlib, popø. jiného
grafického systému
<LI><B>GObject</B> (<TT>-lgobject-2.0</TT>) ... generický typový a objektový
systém, signály
<LI><B>GTK+</B> (<TT>-lgtk-x11-2.0</TT>) ... jádro toolkitu GTK+ a definice
widgetù
<LI><B>Pango</B> (<TT>-lpango-1.0</TT>) ... zobrazování textu
<LI><B>ATK</B> (<TT>-latk-1.0</TT>) ... Accessibility Toolkit, zpøístupnìní
aplikací v&nbsp;GTK+ pro tìlesnì posti¾ené u¾ivatele
</UL>

</BODY>
</HTML>
